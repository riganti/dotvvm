name: Github Actions

on: ["push"]

env:
  DOTVVM_ROOT: ${{ github.workspace }}
  DOTNET_NOLOGO: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_VERSION: '6.0.100'

jobs:
  build-without-warnings:
    name: Build without warnings
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
    - uses: actions/cache@v2
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget
    - uses: actions/checkout@v2
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - uses: microsoft/setup-msbuild@v1.1
    - name: NuGet restore
      run: nuget restore src/DotVVM.sln
    - name: MSBuild build
      run: msbuild -v:m src/DotVVM.sln --no-restore --no-incremental /WarnAsError --configuration Release

  unit-tests:
    name: C# unit tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false # don't kill tests when one environment fails
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
    steps:
    - uses: actions/cache@v2
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install dependencies
      run: dotnet restore src/Tests

    - name: Build framework
      run: dotnet build src/Framework/Framework/DotVVM.Framework.csproj --no-restore --no-incremental /property:WarningLevel=0
    - name: Build Tests (Release)
      run: dotnet build src/Tests --configuration Release --no-restore /property:WarningLevel=0
    - name: Build Tests (Debug)
      run: dotnet build src/Tests --configuration Debug --no-restore /property:WarningLevel=0
    - name: Unit tests (Release)
      run: |
          dotnet test src/Tests --no-build --logger "GitHubActions;report-warnings=true" --configuration Release
    - name: Unit tests (Debug)
      run: |
          dotnet test src/Tests --no-build --logger "GitHubActions;report-warnings=true" --configuration Debug

  js-tests:
    runs-on: ubuntu-latest
    name: JS unit tests
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v2
    - name: yarn install
      run: yarn --cwd src/Framework/Framework/ install --frozen-lockfile
    - name: TypeScript check
      run: yarn --cwd src/Framework/Framework/ tsc-check
    - name: yarn jest
      run: yarn --cwd src/Framework/Framework/ jest --ci --reporters=default --reporters=jest-github-actions-reporter

  ui-tests:
    name: UI tests
    runs-on: ubuntu-latest
    timeout-minutes: 50
    strategy:
      fail-fast: false # don't kill tests when one environment fails
      matrix:
        browser: [firefox, chrome]
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: run.sh
      run: bash ./ci/linux/run.sh --samples-profile seleniumconfig.aspnetcorelatest.${{ matrix.browser }}.json

    - name: Parse Trx files
      uses: NasAmin/trx-parser@v0.2.0
      id: trx-parser
      with:
        TRX_PATH: ${{ github.workspace }}/artifacts/test
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
