name: Github Actions

on: ["push"]

env:
  DOTVVM_ROOT: ${{ github.workspace }}
  DOTNET_NOLOGO: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build-without-warnings:
    name: Build without warnings
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v2
    - name: Set up
      uses: ./.github/setup
    - name: MSBuild build
      run: msbuild src/DotVVM.sln -v:m -t:Rebuild -p:Configuration=Release -warnAsError

  csharp-unit-tests:
    name: C# unit tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false # don't kill tests when one environment fails
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
        configuration: [Debug, Release]
    steps:
    - uses: actions/checkout@v2
    - name: Set up
      uses: ./.github/setup
      with:
        sln: .github/DotVVM.Crossplatform.sln
    - name: Build tests
      run: |
        dotnet msbuild src/Tests -t:Rebuild -p:WarningLevel=0 -p:Configuration=${{ matrix.configuration }}
        dotnet msbuild src/Analyzers/Analyzers.Tests -t:Rebuild -p:WarningLevel=0 -p:Configuration=${{ matrix.configuration }}
    - name: Run tests
      run: |
        dotnet test src/Tests --no-build --logger "GitHubActions;report-warnings=true" --configuration ${{ matrix.configuration }}
        dotnet test src/Analyzers/Analyzers.Tests --no-build --logger "GitHubActions;report-warnings=true" --configuration ${{ matrix.configuration }}


  js-tests:
    runs-on: ubuntu-latest
    name: JS unit tests
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v2
    - name: yarn install
      run: yarn --cwd src/Framework/Framework/ install --frozen-lockfile
    - name: TypeScript check
      run: yarn --cwd src/Framework/Framework/ tsc-check
    - name: yarn jest
      run: yarn --cwd src/Framework/Framework/ jest --ci --reporters=default --reporters=jest-github-actions-reporter

  ui-tests:
    name: UI tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 50
    strategy:
      fail-fast: false # don't kill tests when one environment fails
      matrix:
        browser: [firefox, chrome]
        os: [windows-latest, ubuntu-latest]
    env:
      SLN: "${{ matrix.os == 'windows-latest' && '.github/DotVVM.Windows.sln' || '.github/DotVVM.Crossplatform.sln' }}"
    steps:
    - uses: actions/checkout@v2
    - name: Set up
      uses: ./.github/setup
      with:
        sln: ${{ env.SLN }}
    - name: Run UI tests
      uses: ./.github/uitest
      with:
        browser: ${{ matrix.browser }}
        profile: seleniumconfig.aspnetcorelatest
        token: ${{ secrets.GITHUB_TOKEN }}
