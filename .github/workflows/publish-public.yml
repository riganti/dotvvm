name: publish-public

on:
  workflow_dispatch:
    inputs:
      include:
        type: string
        default: "*"
        description: RegEx describing packages to publish publicly
        required: false
      exclude:
        type: string
        default: ""
        description: RegEx describing packages to exclude from publishing publicly
        required: false
      version:
        type: string
        default: ""
        description: The version of the packages to publish publicly
        required: false

jobs:
  copy:
    name: Copy from internal to public feeds
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:

      - uses: actions/checkout@v3

      - uses: nuget/setup-nuget@v1
        with:
          nuget-version: '6.x'

      - run: dotnet tool restore
        shell: pwsh
        working-directory: src/

      - name: Add internal NuGet feed
        run: ./ci/scripts/Add-InternalNuGetFeed.ps1 `
            -internalFeed "${{ secrets.AZURE_ARTIFACTS_FEED }}" `
            -internalFeedUser "${{ secrets.AZURE_ARTIFACTS_USERNAME }}" `
            -internalFeedPat "${{ secrets.AZURE_ARTIFACTS_PAT }}"

      - name: Add internal npm registry
        run: >
          ./ci/scripts/Add-InternalNpmRegistry.ps1 `
            -targetDirectory "./ci/scripts/npm/dotvvm-types" `
            -internalNpmRegistry "${{ secrets.INTERNAL_NPM_REGISTRY }}" `
            -internalNpmRegistryPat "${{ secrets.INTERNAL_NPM_PAT }}" `
            -internalNpmRegistryUsername "${{ secrets.INTERNAL_NPM_USERNAME }}" `
            -internalNpmRegistryEmail "${{ secrets.INTERNAL_NPM_EMAIL }}"

      - name: Copy NuGet packages
        run: >
          mkdir packages
          "${{ inputs.nuget-package-names }}".Split(",") | ForEach-Object {
            nuget install "$_" `
              -DirectDownload `
              -NonInteractive `
              -SolutionDirectory "/dev/null" `
              -OutputDirectory packages `
              -Version "${{ inputs.version }}" `
              -Source internal
            nuget push "packages/$_.${{ inputs.version }}/$_.${{ inputs.version }}.nupkg"`
              -Source "${{ secrets.PUBLIC_NUGET_FEED }}" `
              -ApiKey "${{ secrets.PUBLIC_NUGET_API_KEY }}" `
              -NonInteractive
          }
