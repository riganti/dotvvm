name: publish-public

on:
  workflow_dispatch:
    inputs:
      include:
        type: string
        default: "*"
        description: RegEx describing packages to publish publicly
        required: false
      exclude:
        type: string
        default: ""
        description: RegEx describing packages to exclude from publishing publicly
        required: false
      version:
        type: string
        default: ""
        description: The version of the packages to publish publicly
        required: false

jobs:
  copy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:

      - uses: actions/checkout@v3

      - uses: nuget/setup-nuget@v1
        with:
          nuget-version: '6.x'

      - name: Add internal NuGet feed
        run: >
          ./ci/scripts/Add-InternalNuGetFeed.ps1 `
            -internalFeed "${{ secrets.AZURE_ARTIFACTS_FEED }}" `
            -internalFeedUser "${{ secrets.AZURE_ARTIFACTS_USERNAME }}" `
            -internalFeedPat "${{ secrets.AZURE_ARTIFACTS_PAT }}"
        shell: pwsh

      - name: Add internal npm registry
        run: >
          ./ci/scripts/Add-InternalNpmRegistry.ps1 `
            -targetDirectory "./ci/scripts/npm/dotvvm-types" `
            -internalNpmRegistry "${{ secrets.INTERNAL_NPM_REGISTRY }}" `
            -internalNpmRegistryPat "${{ secrets.INTERNAL_NPM_PAT }}" `
            -internalNpmRegistryUsername "${{ secrets.INTERNAL_NPM_USERNAME }}" `
            -internalNpmRegistryEmail "${{ secrets.INTERNAL_NPM_EMAIL }}"
        shell: pwsh

      - name: Publish NuGet packages
        run: >
          ./ci/scripts/Copy-NuGetPackages.ps1 `
            -root "${{ github.workspace }}" `
            -nuGetOrgApiKey "${{ secrets.NUGET_ORG_API_KEY }}" `
            -include '${{ inputs.include }}' `
            -exclude '${{ inputs.exclude }}' `
            -version "${{ inputs.version }}"
        shell: pwsh
