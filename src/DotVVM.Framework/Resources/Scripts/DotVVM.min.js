<<<<<<< HEAD
var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(a,i,s,l){return new(s||(s=Promise))(function(e,t){function r(e){try{o(l.next(e))}catch(e){t(e)}}function n(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,n)}o((l=l.apply(a,i||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,a,i,e,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,a&&(i=2&t[0]?a.return:t[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,t[1])).done)return i;switch(a=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,a=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){s.label=t[1];break}if(6===t[0]&&s.label<i[1]){s.label=i[1],i=t;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(t);break}i[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],a=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(){if("undefined"==typeof Promise||!self.fetch){var e=document.createElement("script");e.src=window.dotvvm__polyfillUrl,e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)}}();var DotvvmDomUtils=function(){function e(){}return e.prototype.onDocumentReady=function(e){/in/.test(document.readyState)?setTimeout("dotvvm.domUtils.onDocumentReady("+e+")",9):e()},e.prototype.attachEvent=function(e,t,r,n){void 0===n&&(n=!1),e.addEventListener?e.addEventListener(t,r,n):e.attachEvent("on"+t,r)},e}(),HistoryRecord=function(e,t){this.navigationType=e,this.url=t},DotvvmSpaHistory=function(){function e(){}return e.prototype.pushPage=function(e){history.pushState(new HistoryRecord("SPA",e),"",e)},e.prototype.replacePage=function(e){history.replaceState(new HistoryRecord("SPA",e),"",e)},e.prototype.isSpaPage=function(e){return e&&"SPA"==e.navigationType},e.prototype.getHistoryRecord=function(e){return e},e}(),DotvvmEvents=function(){this.init=new DotvvmEvent("dotvvm.events.init",!0),this.beforePostback=new DotvvmEvent("dotvvm.events.beforePostback"),this.afterPostback=new DotvvmEvent("dotvvm.events.afterPostback"),this.error=new DotvvmEvent("dotvvm.events.error"),this.spaNavigating=new DotvvmEvent("dotvvm.events.spaNavigating"),this.spaNavigated=new DotvvmEvent("dotvvm.events.spaNavigated"),this.redirect=new DotvvmEvent("dotvvm.events.redirect"),this.postbackHandlersStarted=new DotvvmEvent("dotvvm.events.postbackHandlersStarted"),this.postbackHandlersCompleted=new DotvvmEvent("dotvvm.events.postbackHandlersCompleted"),this.postbackResponseReceived=new DotvvmEvent("dotvvm.events.postbackResponseReceived"),this.postbackCommitInvoked=new DotvvmEvent("dotvvm.events.postbackCommitInvoked"),this.postbackViewModelUpdated=new DotvvmEvent("dotvvm.events.postbackViewModelUpdated"),this.postbackRejected=new DotvvmEvent("dotvvm.events.postbackRejected"),this.staticCommandMethodInvoking=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoking"),this.staticCommandMethodInvoked=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoked"),this.staticCommandMethodFailed=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoked")},DotvvmEventHandler=function(e,t){this.handler=e,this.isOneTime=t},DotvvmEvent=function(){function e(e,t){void 0===t&&(t=!1),this.name=e,this.triggerMissedEventsOnSubscribe=t,this.handlers=[],this.history=[]}return e.prototype.subscribe=function(e){if(this.handlers.push(new DotvvmEventHandler(e,!1)),this.triggerMissedEventsOnSubscribe)for(var t=0;t<this.history.length;t++)e(history[t])},e.prototype.subscribeOnce=function(e){this.handlers.push(new DotvvmEventHandler(e,!0))},e.prototype.unsubscribe=function(e){for(var t=0;t<this.handlers.length;t++)if(this.handlers[t].handler===e)return void this.handlers.splice(t,1)},e.prototype.trigger=function(e){for(var t=0;t<this.handlers.length;t++)this.handlers[t].handler(e),this.handlers[t].isOneTime&&(this.handlers.splice(t,1),t--);this.triggerMissedEventsOnSubscribe&&this.history.push(e)},e}(),DotvvmErrorEventArgs=function(e,t,r,n,o,a,i){void 0===a&&(a=void 0),void 0===i&&(i=!1),this.sender=e,this.viewModel=t,this.viewModelName=r,this.xhr=n,this.postbackClientId=o,this.serverResponseObject=a,this.isSpaNavigationError=i,this.handled=!1},DotvvmBeforePostBackEventArgs=function(e,t,r,n){this.sender=e,this.viewModel=t,this.viewModelName=r,this.postbackClientId=n,this.cancel=!1,this.clientValidationFailed=!1},DotvvmAfterPostBackEventArgs=function(){function e(e,t,r,n){void 0===r&&(r=null),this.postbackOptions=e,this.serverResponseObject=t,this.commandResult=r,this.xhr=n,this.isHandled=!1,this.wasInterrupted=!1}return Object.defineProperty(e.prototype,"postbackClientId",{get:function(){return this.postbackOptions.postbackId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewModelName",{get:function(){return this.postbackOptions.viewModelName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewModel",{get:function(){return this.postbackOptions.viewModel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sender",{get:function(){return this.postbackOptions.sender},enumerable:!0,configurable:!0}),e}(),DotvvmSpaNavigatingEventArgs=function(e,t,r){this.viewModel=e,this.viewModelName=t,this.newUrl=r,this.cancel=!1},DotvvmSpaNavigatedEventArgs=function(e,t,r,n){this.viewModel=e,this.viewModelName=t,this.serverResponseObject=r,this.xhr=n,this.isHandled=!1},DotvvmRedirectEventArgs=function(e,t,r,n){this.viewModel=e,this.viewModelName=t,this.url=r,this.replace=n,this.isHandled=!1},DotvvmFileUpload=function(){function e(){}return e.prototype.showUploadDialog=function(e){var t=this.getIframe(e);this.createUploadId(e,t),this.openUploadDialog(t)},e.prototype.getIframe=function(e){return e.parentElement.previousSibling},e.prototype.openUploadDialog=function(e){var t=e.contentWindow;t&&t.document.getElementById("upload").click()},e.prototype.createUploadId=function(e,t){t=t||this.getIframe(e);var r="DotVVM_upl"+(new Date).getTime().toString();e.parentElement.parentElement.setAttribute("data-dotvvm-upload-id",r),t.setAttribute("data-dotvvm-upload-id",r)},e.prototype.reportProgress=function(e,t,r,n){var o=document.querySelector("div[data-dotvvm-upload-id='"+e.value+"']"),a=ko.dataFor(o.firstChild);if("string"==typeof n)a.Error(n);else{a.Error("");for(var i=0;i<n.length;i++)a.Files.push(dotvvm.serialization.wrapObservable(dotvvm.serialization.deserialize(n[i])));(o.attributes["data-dotvvm-upload-completed"]||{value:null}).value&&new Function(o.attributes["data-dotvvm-upload-completed"].value).call(o)}a.Progress(r),a.IsBusy(t)},e}(),DotvvmFileUploadCollection=function(){this.Files=ko.observableArray(),this.Progress=ko.observable(0),this.Error=ko.observable(),this.IsBusy=ko.observable()},DotvvmFileUploadData=function(){this.FileId=ko.observable(),this.FileName=ko.observable(),this.FileSize=ko.observable(),this.IsFileTypeAllowed=ko.observable(),this.IsMaxSizeExceeded=ko.observable(),this.IsAllowed=ko.observable()},DotvvmFileSize=function(){this.Bytes=ko.observable(),this.FormattedText=ko.observable()},DotvvmGlobalize=function(){function e(){}return e.prototype.getGlobalize=function(){var e=window.dotvvm_Globalize;if(!e)throw new Error("Resource 'globalize' is not included (symbol 'dotvvm_Globalize' could not be found).\nIt is usually included automatically when needed, but sometime it's not possible, so you will have to include it in your page using '<dot:RequiredResource Name=\"globalize\" />'");return e},e.prototype.format=function(e){for(var o=this,a=[],t=1;t<arguments.length;t++)a[t-1]=arguments[t];return e.replace(/\{([1-9]?[0-9]+)(:[^}]+)?\}/g,function(e,t,r){var n=a[parseInt(t)];return r?o.formatString(r,n):n})},e.prototype.formatString=function(e,t){if(null==(t=ko.unwrap(t))||""===t)return"";if("string"==typeof t&&null==(t=this.parseDotvvmDate(t)))throw new Error("Could not parse "+t+" as a date");return""!==e&&null!==e||(e="G"),this.getGlobalize().format(t,e,dotvvm.culture)},e.prototype.parseDotvvmDate=function(e){var t=e.match("^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]{3,7})$");return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3]),parseInt(t[4]),parseInt(t[5]),parseInt(t[6]),7<t.length?parseInt(t[7].substring(1,4)):0):null},e.prototype.parseNumber=function(e){return this.getGlobalize().parseFloat(e,10,dotvvm.culture)},e.prototype.parseDate=function(e,t,r){return this.getGlobalize().parseDate(e,t,dotvvm.culture,r)},e.prototype.bindingDateToString=function(t,r){var n=this;if(void 0===r&&(r="G"),!t)return"";var o=function(){var e=ko.unwrap(t);return"string"==typeof e?n.parseDotvvmDate(e):e},e=function(){var e=o();return null!=e?n.getGlobalize().format(e,r,dotvvm.culture):""};if(ko.isWriteableObservable(t)){var a="string"==typeof o()?function(e){return t(null==e?null:dotvvm.serialization.serializeDate(e,!1))}:t;return ko.pureComputed({read:function(){return e()},write:function(e){return a(n.getGlobalize().parseDate(e,r,dotvvm.culture))}})}return ko.pureComputed(function(){return e()})},e.prototype.bindingNumberToString=function(n,t){var o=this;if(void 0===t&&(t="G"),null==n)return"";var e=function(){var e=function(){var e=ko.unwrap(n);return"string"==typeof e?o.parseNumber(e):e}();return null!=e?o.getGlobalize().format(e,t,dotvvm.culture):""};return ko.isWriteableObservable(n)?ko.pureComputed({read:function(){return e()},write:function(e){var t=o.getGlobalize().parseFloat(e,10,dotvvm.culture),r=null==e||null!=t&&!isNaN(t);n(r?t:null)}}):ko.pureComputed(function(){return e()})},e}(),PostbackOptions=function(e,t,r,n,o){void 0===r&&(r=[]),this.postbackId=e,this.sender=t,this.args=r,this.viewModel=n,this.viewModelName=o,this.additionalPostbackData={}},ConfirmPostBackHandler=function(){function e(e){this.message=e}return e.prototype.execute=function(r,e){var n=this;return new Promise(function(e,t){confirm(n.message)?r().then(e,t):t({type:"handler",handler:n,message:"The postback was not confirmed"})})},e}(),SuppressPostBackHandler=function(){function e(e){this.suppress=e}return e.prototype.execute=function(r,e){var n=this;return new Promise(function(e,t){n.suppress?t({type:"handler",handler:n,message:"The postback was suppressed"}):r().then(e,t)})},e}(),DotvvmSerialization=function(){function e(){}return e.prototype.wrapObservable=function(e){return ko.isObservable(e)?e:ko.observable(e)},e.prototype.deserialize=function(e,t,r){if(void 0===r&&(r=!1),ko.isObservable(e))throw new Error("Parameter viewModel should not be an observable. Maybe you forget to invoke the observable you are passing as a viewModel parameter.");return this.isPrimitive(e)?this.deserializePrimitive(e,t):e instanceof Date?this.deserializeDate(e,t):e instanceof Array?this.deserializeArray(e,t,r):this.deserializeObject(e,t,r)},e.prototype.deserializePrimitive=function(e,t){return ko.isObservable(t)?(t(e),t):e},e.prototype.deserializeDate=function(e,t){return e=dotvvm.serialization.serializeDate(e),ko.isObservable(t)?(t(e),t):e},e.prototype.deserializeArray=function(e,t,r){return void 0===r&&(r=!1),this.isObservableArray(t)&&null!=t()&&t().length===e.length?this.updateArrayItems(e,t,r):t=this.rebuildArrayFromScratch(e,t,r),t},e.prototype.rebuildArrayFromScratch=function(e,t,r){for(var n=[],o=0;o<e.length;o++)n.push(this.wrapObservableObjectOrArray(this.deserialize(ko.unwrap(e[o]),{},r)));return ko.isObservable(t)?(t=this.extendToObservableArrayIfRequired(t))(n):t=n,t},e.prototype.updateArrayItems=function(e,t,r){for(var n=t(),o=0;o<e.length;o++){var a=ko.unwrap(n[o]),i=this.deserialize(ko.unwrap(e[o]),a,r);a!==i&&(ko.isObservable(n[o])?n[o]()!==i&&(n[o]=this.extendToObservableArrayIfRequired(n[o]),n[o](i)):n[o]=this.wrapObservableObjectOrArray(i))}},e.prototype.deserializeObject=function(e,t,r){var n=ko.unwrap(t);this.isPrimitive(n)&&(n={});for(var o=0,a=Object.getOwnPropertyNames(e);o<a.length;o++){var i=a[o];if(!this.isOptionsProperty(i)){var s=e[i];if(void 0!==s&&(ko.isObservable(s)||"function"!=typeof s)){var l=e[i+"$options"];!r&&l&&l.doNotUpdate||this.copyProperty(s,n,i,r,l)}}}for(var u=0,d=Object.getOwnPropertyNames(e);u<d.length;u++){i=d[u];this.isOptionsProperty(i)&&this.copyPropertyMetadata(n,i,e)}return ko.isObservable(t)?n!==t()&&t(n):t=n,t},e.prototype.copyProperty=function(e,t,r,n,o){var a=this.deserialize(ko.unwrap(e),t[r],n);if(e instanceof Date&&(t[r+"$options"]=__assign({},t[r+"$options"],{isDate:!0})),ko.isObservable(a)?a()!==t[r]()&&(t[r]=this.extendToObservableArrayIfRequired(t[r]),t[r](a())):t[r]=this.wrapObservableObjectOrArray(a),o&&o.clientExtenders&&ko.isObservable(t[r]))for(var i=0;i<o.clientExtenders.length;i++){var s={},l=o.clientExtenders[i];s[l.name]=l.parameter,t[r].extend(s)}},e.prototype.copyPropertyMetadata=function(e,t,r){e[t]=__assign({},e[t],r[t]);var n=t.substring(0,t.length-"$options".length);void 0===e[n]&&(e[n]=ko.observable())},e.prototype.extendToObservableArrayIfRequired=function(e){if(!ko.isObservable(e))throw new Error("Trying to extend a non-observable to an observable array.");return this.isObservableArray(e)||(ko.utils.extend(e,ko.observableArray.fn),e=e.extend({trackArrayChanges:!0})),e},e.prototype.wrapObservableObjectOrArray=function(e){return Array.isArray(e)?ko.observableArray(e):ko.observable(e)},e.prototype.isPrimitive=function(e){return null==e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e},e.prototype.isOptionsProperty=function(e){return/\$options$/.test(e)},e.prototype.isObservableArray=function(e){return ko.isObservable(e)&&"removeAll"in e},e.prototype.serialize=function(e,t){if(void 0===t&&(t={}),(t=ko.utils.extend({},t)).pathOnly&&t.path&&0===t.path.length&&(t.pathOnly=!1),null==e)return null;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;if(ko.isObservable(e))return this.serialize(e(),t);if("function"==typeof e)return null;if(e instanceof Array){if(t.pathOnly&&t.path){var r=parseInt(t.path.pop());return(n=new Array(r+1))[r]=this.serialize(e[r],t),t.path.push(r.toString()),n}for(var n=[],o=0;o<e.length;o++)n.push(this.serialize(e[o],t));return n}if(e instanceof Date)return t.restApiTarget?e:this.serializeDate(e);var a=t.path&&t.path.pop(),i={};for(var s in e)if(e.hasOwnProperty(s)){if(t.pathOnly&&s!==a)continue;var l=e[s];if(t.ignoreSpecialProperties&&"$"===s[0])continue;if(!t.serializeAll&&(/\$options$/.test(s)||"$validationErrors"===s))continue;if(void 0===l)continue;if(!ko.isObservable(l)&&"function"==typeof l)continue;var u=e[s+"$options"];if(!t.serializeAll&&u&&u.doNotPost);else if(t.oneLevel)i[s]=ko.unwrap(l);else if(!t.serializeAll&&u&&u.pathOnly&&t.pathMatcher){var d=u.pathOnly;d instanceof Array||(d=t.path||this.findObject(l,t.pathMatcher)),d&&(0===d.length?i[s]=this.serialize(l,t):i[s]=this.serialize(l,{ignoreSpecialProperties:t.ignoreSpecialProperties,serializeAll:t.serializeAll,path:d,pathOnly:!0}))}else i[s]=this.serialize(l,t);u&&u.type&&!this.validateType(i[s],u.type)&&(delete i[s],u.wasInvalid=!0)}return a&&t.path&&t.path.push(a),i},e.prototype.validateType=function(e,t){var r="?"===t[t.length-1];if(r&&(t=t.substr(0,t.length-1)),r&&(null==e||""==e))return!0;if(!r&&null==e)return!1;var n=/(u?)int(\d*)/.exec(t);if(n){if(!/^-?\d*$/.test(e))return!1;var o="u"===n[1],a=parseInt(n[2]),i=0,s=Math.pow(2,a)-1;o||(s+=i=-Math.floor(s/2));var l=parseInt(e);return i<=l&&l<=s&&l===parseFloat(e)}return"number"!==t&&"single"!==t&&"double"!==t&&"decimal"!==t||(+e===e||!isNaN(+e)&&"string"==typeof e)},e.prototype.findObject=function(e,t){if(t(e))return[];if(t(e=ko.unwrap(e)))return[];if("object"!=typeof e)return null;for(var r in e)if(e.hasOwnProperty(r)){var n=this.findObject(e[r],t);if(n)return n.push(r),n}return null},e.prototype.flatSerialize=function(e){return this.serialize(e,{ignoreSpecialProperties:!0,oneLevel:!0,serializeAll:!0})},e.prototype.getPureObject=function(e){if((e=ko.unwrap(e))instanceof Array)return e.map(this.getPureObject.bind(this));var t={};for(var r in e)"$"!=r[0]&&(t[r]=e[r]);return t},e.prototype.pad=function(e,t){for(;e.length<t;)e="0"+e;return e},e.prototype.serializeDate=function(e,t){if(void 0===t&&(t=!0),null==e)return null;if("string"==typeof e)return null==dotvvm.globalize.parseDotvvmDate(e)&&console.error(new Error("Date "+e+" is invalid.")),e;var r=new Date(e.getTime());return t?r.setMinutes(e.getMinutes()+e.getTimezoneOffset()):r=e,this.pad(r.getFullYear().toString(),4)+"-"+this.pad((r.getMonth()+1).toString(),2)+"-"+this.pad(r.getDate().toString(),2)+"T"+this.pad(r.getHours().toString(),2)+":"+this.pad(r.getMinutes().toString(),2)+":"+this.pad(r.getSeconds().toString(),2)+"."+this.pad(r.getMilliseconds().toString(),3)+"0000"},e}();document.getElementByDotvvmId=function(e){return document.querySelector("[data-dotvvm-id='"+e+"']")};var DotVVM=function(){function e(){var n,a=this;this.postBackCounter=0,this.lastStartedPostack=0,this.resourceSigns={},this.isViewModelUpdating=!0,this.spaHistory=new DotvvmSpaHistory,this.viewModelObservables={},this.isSpaReady=ko.observable(!1),this.viewModels={},this.serialization=new DotvvmSerialization,this.postbackHandlers={confirm:function(e){return new ConfirmPostBackHandler(e.message)},suppress:function(e){return new SuppressPostBackHandler(e.suppress)},timeout:function(e){return e.time?a.createWindowSetTimeoutHandler(e.time):a.windowSetTimeoutHandler},"concurrency-default":function(r){return{name:"concurrency-default",before:["setIsPostbackRunning"],execute:function(e,t){return a.commonConcurrencyHandler(e(),t,r.q||"default")}}},"concurrency-deny":function(n){return{name:"concurrency-deny",before:["setIsPostbackRunning"],execute:function(e,t){var r=n.q||"default";return 0<dotvvm.getPostbackQueue(r).noRunning?Promise.reject({type:"handler",handler:this,message:"An postback is already running"}):dotvvm.commonConcurrencyHandler(e(),t,r)}}},"concurrency-queue":function(o){return{name:"concurrency-queue",before:["setIsPostbackRunning"],execute:function(e,t){var r=o.q||"default",n=function(){return dotvvm.commonConcurrencyHandler(e(),t,r)};return 0<dotvvm.getPostbackQueue(r).noRunning?new Promise(function(e){dotvvm.getPostbackQueue(r).queue.push(function(){return e(n())})}):n()}}},suppressOnUpdating:function(e){return{name:"suppressOnUpdating",before:["setIsPostbackRunning","concurrency-default","concurrency-queue","concurrency-deny"],execute:function(e,t){return dotvvm.isViewModelUpdating?Promise.reject({type:"handler",handler:this,message:"ViewModel is updating, so it's probably false onchange event"}):e()}}}},this.suppressOnDisabledElementHandler={name:"suppressOnDisabledElement",before:["setIsPostbackRunning","concurrency-default","concurrency-queue","concurrency-deny"],execute:function(e,t){return t.sender&&dotvvm.isPostBackProhibited(t.sender)?Promise.reject({type:"handler",handler:a,message:"PostBack is prohibited on disabled element"}):e()}},this.beforePostbackEventPostbackHandler={execute:function(e,t){var r=new DotvvmBeforePostBackEventArgs(t.sender,t.viewModel,t.viewModelName,t.postbackId);return a.events.beforePostback.trigger(r),r.cancel?Promise.reject({type:"event",options:t}):e()}},this.isPostBackRunningHandler=(n=0,{name:"setIsPostbackRunning",before:["eventInvoke-postbackHandlersStarted"],execute:function(e,t){a.isPostbackRunning(!0),n++;var r=e();return r.then(function(){return a.isPostbackRunning(!!--n)},function(){return a.isPostbackRunning(!!--n)}),r}}),this.windowSetTimeoutHandler=this.createWindowSetTimeoutHandler(0),this.commonConcurrencyHandler=function(e,r,t){var n=a.getPostbackQueue(t);n.noRunning++,dotvvm.updateProgressChangeCounter(dotvvm.updateProgressChangeCounter()+1);var o=function(){if(n.noRunning--,dotvvm.updateProgressChangeCounter(dotvvm.updateProgressChangeCounter()-1),0<n.queue.length){var e=n.queue.shift();window.setTimeout(e,0)}};return e.then(function(e){var t=a.lastStartedPostack==r.postbackId?e:function(){return Promise.reject(null)};return function(){var e=t();return e.then(o,o),e}},function(e){return o(),Promise.reject(e)})},this.defaultConcurrencyPostbackHandler=this.postbackHandlers["concurrency-default"]({}),this.postbackQueues={},this.postbackHandlersStartedEventHandler={name:"eventInvoke-postbackHandlersStarted",execute:function(e,t){return dotvvm.events.postbackHandlersStarted.trigger(t),e()}},this.postbackHandlersCompletedEventHandler={name:"eventInvoke-postbackHandlersCompleted",after:["eventInvoke-postbackHandlersStarted"],execute:function(e,t){return dotvvm.events.postbackHandlersCompleted.trigger(t),e()}},this.globalPostbackHandlers=[this.suppressOnDisabledElementHandler,this.isPostBackRunningHandler,this.postbackHandlersStartedEventHandler],this.globalLaterPostbackHandlers=[this.postbackHandlersCompletedEventHandler,this.beforePostbackEventPostbackHandler],this.events=new DotvvmEvents,this.globalize=new DotvvmGlobalize,this.evaluator=new DotvvmEvaluator,this.domUtils=new DotvvmDomUtils,this.fileUpload=new DotvvmFileUpload,this.extensions={},this.isPostbackRunning=ko.observable(!1),this.updateProgressChangeCounter=ko.observable(0)}return e.prototype.createWindowSetTimeoutHandler=function(r){return{name:"timeout",before:["eventInvoke-postbackHandlersStarted","setIsPostbackRunning"],execute:function(e,t){return new Promise(function(e,t){return window.setTimeout(e,r)}).then(function(){return e()})}}},e.prototype.getPostbackQueue=function(e){return void 0===e&&(e="default"),this.postbackQueues[e]||(this.postbackQueues[e]={queue:[],noRunning:0}),this.postbackQueues[e]},e.prototype.init=function(t,e){var r=this;this.addKnockoutBindingHandlers();var n=this.viewModels[t]=JSON.parse(document.getElementById("__dot_viewmodel_"+t).value);if(n.resources)for(var o in n.resources)this.resourceSigns[o]=!0;n.renderedResources&&n.renderedResources.forEach(function(e){return r.resourceSigns[e]=!0});var a=n.resultIdFragment,i=n.viewModel=this.serialization.deserialize(this.viewModels[t].viewModel,{},!0);this.culture=e,this.validation=new DotvvmValidation(this),this.viewModelObservables[t]=ko.observable(i),ko.applyBindings(this.viewModelObservables[t],document.documentElement),this.events.init.trigger({viewModel:i});var s=this.getSpaPlaceHolder();if(null!=s){var l=function(e){return r.handleHashChange(t,s,e)};this.useHistoryApiSpaNavigation=JSON.parse(s.getAttribute("data-dotvvm-spacontentplaceholder-usehistoryapi")),this.useHistoryApiSpaNavigation&&(l=function(e){return r.handleHashChangeWithHistory(t,s,e)});this.domUtils.attachEvent(window,"hashchange",function(){return l(!1)}),l(!0)}if(window.addEventListener("popstate",function(e){return r.handlePopState(t,e,null!=s)}),this.isViewModelUpdating=!1,a)if(s){var u=document.getElementById(a);u&&"function"==typeof u.scrollIntoView&&u.scrollIntoView(!0)}else location.hash=a;this.domUtils.attachEvent(window,"beforeunload",function(e){r.persistViewModel(t)})},e.prototype.handlePopState=function(e,t,r){if(this.spaHistory.isSpaPage(t.state)){var n=this.spaHistory.getHistoryRecord(t.state);r?this.navigateCore(e,n.url):this.performRedirect(n.url,!0),t.preventDefault()}},e.prototype.handleHashChangeWithHistory=function(e,t,r){var n=this;if(0===document.location.hash.indexOf("#!/"))this.navigateCore(e,document.location.hash.substring(2),function(e){n.spaHistory.replacePage(e)});else{var o=t.getAttribute("data-dotvvm-spacontentplaceholder-defaultroute");if(!t.hasAttribute("data-dotvvm-spacontentplaceholder-content")&&o)this.navigateCore(e,"/"+o,function(e){return n.spaHistory.replacePage(e)});else{this.isSpaReady(!0),t.style.display="";var a=location.pathname+location.search+location.hash;this.spaHistory.replacePage(a)}}},e.prototype.handleHashChange=function(e,t,r){if(0===document.location.hash.indexOf("#!/"))this.navigateCore(e,document.location.hash.substring(2));else{var n=t.getAttribute("data-dotvvm-spacontentplaceholder-defaultroute");if(n)n="#!/"+n,n=this.fixSpaUrlPrefix(n),this.performRedirect(n,r);else if(r)this.isSpaReady(!0),t.style.display="";else{var o=(n=document.location.toString()).indexOf("/","https://".length);n=0<o?n.substring(o):"/",this.navigateCore(e,n)}}},e.prototype.persistViewModel=function(e){var t=this.viewModels[e],r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);r.viewModel=this.serialization.serialize(r.viewModel,{serializeAll:!0}),document.getElementById("__dot_viewmodel_"+e).value=JSON.stringify(r)},e.prototype.backUpPostBackConter=function(){return++this.postBackCounter},e.prototype.isPostBackStillActive=function(e){return this.postBackCounter===e},e.prototype.fetchCsrfToken=function(o){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return null!=(t=this.viewModels[o].viewModel).$csrfToken?[3,3]:[4,fetch((this.viewModels[o].virtualDirectory||"")+"/___dotvvm-create-csrf-token___")];case 1:if(200!=(r=e.sent()).status)throw new Error("Can't fetch CSRF token: "+r.statusText);return n=t,[4,r.text()];case 2:n.$csrfToken=e.sent(),e.label=3;case 3:return[2,t.$csrfToken]}})})},e.prototype.staticCommandPostback=function(a,i,s,l,u,d){void 0===u&&(u=function(e){}),void 0===d&&(d=function(e){}),__awaiter(this,void 0,void 0,function(){var t,r,n,o=this;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.fetchCsrfToken(a)];case 1:return t=e.sent(),[3,3];case 2:return r=e.sent(),this.events.error.trigger(new DotvvmErrorEventArgs(i,this.viewModels[a].viewModel,a,null,null)),console.warn("CSRF token fetch failed."),d({error:r}),[2];case 3:return n=this.serialization.serialize({args:l,command:s,$csrfToken:t}),dotvvm.events.staticCommandMethodInvoking.trigger(n),this.postJSON(this.viewModels[a].url,"POST",ko.toJSON(n),function(t){try{o.isViewModelUpdating=!0;var e=JSON.parse(t.responseText);if("action"in e){if("redirect"==e.action)return o.handleRedirect(e,a),void d({xhr:t,error:"redirect"});throw new Error("Invalid action "+e.action)}var r=e.result;dotvvm.events.staticCommandMethodInvoked.trigger(__assign({},n,{result:r,xhr:t})),u(r)}catch(e){dotvvm.events.staticCommandMethodFailed.trigger(__assign({},n,{xhr:t,error:e})),d({xhr:t,error:e})}finally{o.isViewModelUpdating=!1}},function(e){if(/^application\/json(;|$)/.test(e.getResponseHeader("Content-Type"))&&"invalidCsrfToken"===JSON.parse(e.responseText).action)return o.viewModels[a].viewModel.$csrfToken=null,console.log("Resending postback due to invalid CSRF token."),void o.staticCommandPostback(a,i,s,l,u,d);o.events.error.trigger(new DotvvmErrorEventArgs(i,o.viewModels[a].viewModel,a,e,null)),console.warn("StaticCommand postback failed: "+e.status+" - "+e.statusText,e),d({xhr:e}),dotvvm.events.staticCommandMethodFailed.trigger(__assign({},n,{xhr:e}))},function(e){e.setRequestHeader("X-PostbackType","StaticCommand")}),[2]}})})},e.prototype.processPassedId=function(e,t){if("string"==typeof e||null==e)return e;if("object"==typeof e&&e.expr)return this.evaluator.evaluateOnViewModel(t,e.expr);throw new Error("invalid argument")},e.prototype.getPostbackHandler=function(e){var t=this.postbackHandlers[e];if(t)return t;throw new Error("Could not find postback handler of name '"+e+"'")},e.prototype.isPostbackHandler=function(e){return e&&"function"==typeof e.execute},e.prototype.findPostbackHandlers=function(n,e){var o=this,a=function(e,t){return!1===t.enabled?null:o.getPostbackHandler(e)(t)};return e.map(function(e){return"string"==typeof e?a(e,{}):o.isPostbackHandler(e)?e:e instanceof Array?(t=e[0],r=e[1],a(t,"function"==typeof r?r(n,n.$data):r)):a(e.name,e.options&&e.options(n));var t,r}).filter(function(e){return null!=e})},e.prototype.sortHandlers=function(o){for(var r=function(){for(var t={},e=0,r=o;e<r.length;e++){var n=r[e];null!=n.name&&(t[n.name]=n)}return function(e){return"string"==typeof e?t[e]:e}}(),i=o.map(function(e,t){return e["@sort_index"]=t,{handler:e,deps:(e.after||[]).map(r)}}),e=0,t=o;e<t.length;e++){var n=t[e];if(n.before)for(var a=0,s=n.before.map(r);a<s.length;a++){var l=s[a];if(l){var u=l["@sort_index"];i[u].deps.push(n)}}}for(var d=[],v=new Uint8Array(i.length),c=function(e){switch(v[e]){case 0:break;case 1:throw new Error("Cyclic PostbackHandler dependency found.");case 2:return;default:throw new Error("")}if(1!=v[e]){v[e]=1;for(var t=i[e],r=t.handler,n=0,o=t.deps;n<o.length;n++){var a=o[n];c(a["@sort_index"])}v[e]=2,d.push(r)}},p=0;p<i.length;p++)c(p);return d},e.prototype.applyPostbackHandlersCore=function(e,n,t){var r=function(e){return"function"==typeof e?e:function(){return Promise.resolve(new DotvvmAfterPostBackEventArgs(n,null,e))}};return null==t||0===t.length?e(n).then(r,function(e){return Promise.reject(e)}):this.sortHandlers(t).reduceRight(function(e,t,r){return function(){return t.execute(e,n)}},function(){return e(n).then(r,function(e){return Promise.reject(e)})})()},e.prototype.applyPostbackHandlers=function(e,t,r,n,o,a,i){void 0===n&&(n=[]),void 0===o&&(o=ko.contextFor(t)),void 0===a&&(a=o.$root);var s=new PostbackOptions(this.backUpPostBackConter(),t,n,a,i),l=this.applyPostbackHandlersCore(e,s,this.findPostbackHandlers(o,this.globalPostbackHandlers.concat(r||[]).concat(this.globalLaterPostbackHandlers))).then(function(e){return e()},function(e){return Promise.reject(e)});return l.catch(function(e){e&&console.log("Rejected: "+e)}),l},e.prototype.postbackCore=function(c,o,a,i,s,l){var e=this;return new Promise(function(r,n){return __awaiter(e,void 0,void 0,function(){var u,d,t,v=this;return __generator(this,function(e){switch(e.label){case 0:u=c.viewModelName,d=this.viewModels[u].viewModel,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.fetchCsrfToken(u)];case 2:return e.sent(),[3,4];case 3:return e.sent(),n({type:"network",options:c,args:new DotvvmErrorEventArgs(c.sender,d,u,null,c.postbackId)}),[2];case 4:return this.lastStartedPostack=c.postbackId,this.updateDynamicPathFragments(s,o),t={viewModel:this.serialization.serialize(d,{pathMatcher:function(e){return s&&e==s.$data}}),currentPath:o,command:a,controlUniqueId:this.processPassedId(i,s),additionalData:c.additionalPostbackData,renderedResources:this.viewModels[u].renderedResources,commandArgs:l},this.postJSON(this.viewModels[u].url,"POST",ko.toJSON(t),function(l){dotvvm.events.postbackResponseReceived.trigger({}),r(function(){return new Promise(function(a,i){dotvvm.events.postbackCommitInvoked.trigger({});var e=l.getResponseHeader("Location"),s=null!=e&&0<e.length?{action:"redirect",url:e}:JSON.parse(l.responseText);!s.viewModel&&s.viewModelDiff&&(s.viewModel=v.patch(t.viewModel,s.viewModelDiff)),v.loadResourceList(s.resources,function(){var e=!1;if("successfulCommand"===s.action){try{v.isViewModelUpdating=!0;var t=v.cleanUpdatedControls(s);s.viewModel&&(ko.delaySync.pause(),v.serialization.deserialize(s.viewModel,v.viewModels[u].viewModel),ko.delaySync.resume()),e=!0,v.cleanUpdatedControls(s,t),v.restoreUpdatedControls(s,t,!0)}finally{v.isViewModelUpdating=!1}dotvvm.events.postbackViewModelUpdated.trigger({})}else if("redirect"===s.action)return v.handleRedirect(s,u),a();var r=s.resultIdFragment;if(r)if(v.getSpaPlaceHolder()||location.hash=="#"+r){var n=document.getElementById(r);n&&"function"==typeof n.scrollIntoView&&n.scrollIntoView(!0)}else location.hash=r;if(e){var o=new DotvvmAfterPostBackEventArgs(c,s,s.commandResult,l);a(o)}else i(new DotvvmErrorEventArgs(c.sender,d,u,l,c.postbackId,s))})})})},function(e){if(/^application\/json(;|$)/.test(e.getResponseHeader("Content-Type"))&&"invalidCsrfToken"===JSON.parse(e.responseText).action)return v.viewModels[u].viewModel.$csrfToken=null,console.log("Resending postback due to invalid CSRF token."),void v.postbackCore(c,o,a,i,s,l).then(r,n);n({type:"network",options:c,args:new DotvvmErrorEventArgs(c.sender,d,u,e,c.postbackId)})}),[2]}})})})},e.prototype.handleSpaNavigation=function(e){return"_blank"==e.getAttribute("target")||this.handleSpaNavigationCore(e.getAttribute("href"))},e.prototype.handleSpaNavigationCore=function(e){var t=this;if(e&&0===e.indexOf("/")){return e=this.removeVirtualDirectoryFromUrl(e,"root"),this.navigateCore("root",e,function(e){history.state&&history.state.url==e||t.spaHistory.pushPage(e)}),!1}return!0},e.prototype.postBack=function(e,t,r,n,o,a,i,s){var l=this;a=a||ko.contextFor(t);var u=this.findPostbackHandlers(a,this.globalPostbackHandlers.concat(i||[]).concat(this.globalLaterPostbackHandlers));0==u.filter(function(e){return e.name&&0==e.name.indexOf("concurrency-")}).length&&u.push(this.defaultConcurrencyPostbackHandler);var d=new PostbackOptions(this.backUpPostBackConter(),t,s,a.$data,e),v=this.applyPostbackHandlersCore(function(e){return l.postbackCore(e,r,n,o,a,s)},d,u).then(function(e){return e().then(function(e){return e},function(e){return Promise.reject({type:"commit",args:e})})},function(e){return Promise.reject(e)});return v.then(function(e){return e&&l.events.afterPostback.trigger(e)},function(e){var t=new DotvvmAfterPostBackEventArgs(d,"commit"==e.type&&e.args?e.args.serverResponseObject:null,d.postbackId);"handler"==e.type||"event"==e.type?(t.wasInterrupted=!0,l.events.postbackRejected.trigger({})):"network"==e.type&&l.events.error.trigger(e.args),l.events.afterPostback.trigger(t)}),v},e.prototype.loadResourceList=function(e,t){var r="";for(var n in e){if(!/^__noname_\d+$/.test(n)){if(this.resourceSigns[n])continue;this.resourceSigns[n]=!0}r+=e[n]+" "}if(""!==r.trim()){var o=document.createElement("div");o.innerHTML=r;for(var a=[],i=0;i<o.children.length;i++)a.push(o.children.item(i));this.loadResourceElements(a,0,t)}else setTimeout(t,4)},e.prototype.loadResourceElements=function(e,t,r){var n=this;if(t>=e.length)r();else{var o=e[t],a=!1;if("script"==o.tagName.toLowerCase()){var i=o,s=document.createElement("script");i.src&&(s.src=i.src,a=!0),i.type&&(s.type=i.type),i.text&&(s.text=i.text),o.id&&(s.id=o.id),o=s}else if("link"==o.tagName.toLowerCase()){var l=o,u=document.createElement("link");l.href&&(u.href=l.href),l.rel&&(u.rel=l.rel),l.type&&(u.type=l.type),o=u}a&&(o.addEventListener("load",function(){return n.loadResourceElements(e,t+1,r)}),o.addEventListener("error",function(){return n.loadResourceElements(e,t+1,r)})),document.head.appendChild(o),a||this.loadResourceElements(e,t+1,r)}},e.prototype.getSpaPlaceHolder=function(){var e=document.getElementsByName("__dot_SpaContentPlaceHolder");return 1==e.length?e[0]:null},e.prototype.navigateCore=function(i,e,t){var s=this,r=this.viewModels[i].viewModel,n=this.backUpPostBackConter(),o=new DotvvmSpaNavigatingEventArgs(r,i,e);if(this.events.spaNavigating.trigger(o),!o.cancel){var a=this.viewModels[i].virtualDirectory||"",l="/___dotvvm-spa___"+this.addLeadingSlash(e),u=this.addLeadingSlash(this.concatUrl(a,l)),d=this.getSpaPlaceHolder();if(d){t&&t(this.addLeadingSlash(this.concatUrl(a,this.addLeadingSlash(e))));var v=d.attributes["data-dotvvm-spacontentplaceholder"].value;this.getJSON(u,"GET",v,function(o){if(s.isPostBackStillActive(n)){var a=JSON.parse(o.responseText);s.loadResourceList(a.resources,function(){var e=!1;if("successfulCommand"!==a.action&&a.action){if("redirect"===a.action)return void s.handleRedirect(a,i,!0)}else try{s.isViewModelUpdating=!0;var t=s.cleanUpdatedControls(a);for(var r in s.viewModels[i]={},a)a.hasOwnProperty(r)&&(s.viewModels[i][r]=a[r]);ko.delaySync.pause(),s.serialization.deserialize(a.viewModel,s.viewModels[i].viewModel),ko.delaySync.resume(),e=!0,s.viewModelObservables[i](s.viewModels[i].viewModel),s.restoreUpdatedControls(a,t,!0),s.isSpaReady(!0)}finally{s.isViewModelUpdating=!1}var n=new DotvvmSpaNavigatedEventArgs(s.viewModels[i].viewModel,i,a,o);if(s.events.spaNavigated.trigger(n),!e&&!n.isHandled)throw"Invalid response from server!"})}},function(e){if(s.isPostBackStillActive(n)){var t=new DotvvmErrorEventArgs(void 0,r,i,e,-1,void 0,!0);s.events.error.trigger(t),t.handled||alert(e.responseText)}})}else document.location.href=u}},e.prototype.handleRedirect=function(e,t,r){var n;void 0===r&&(r=!1),null!=e.replace&&(r=e.replace),n=this.getSpaPlaceHolder()&&!this.useHistoryApiSpaNavigation&&e.url.indexOf("//")<0&&e.allowSpa?("#!"===(n="#!"+this.removeVirtualDirectoryFromUrl(e.url,t))&&(n="#!/"),this.fixSpaUrlPrefix(n)):e.url;var o=new DotvvmRedirectEventArgs(dotvvm.viewModels[t],t,n,r);this.events.redirect.trigger(o),this.performRedirect(n,r,e.allowSpa&&this.useHistoryApiSpaNavigation)},e.prototype.performRedirect=function(e,t,r){if(t)location.replace(e);else if(r)this.handleSpaNavigationCore(e);else{var n=this.fakeRedirectAnchor;n||((n=document.createElement("a")).style.display="none",n.setAttribute("data-dotvvm-fake-id","dotvvm_fake_redirect_anchor_87D7145D_8EA8_47BA_9941_82B75EE88CDB"),document.body.appendChild(n),this.fakeRedirectAnchor=n),n.href=e,n.click()}},e.prototype.fixSpaUrlPrefix=function(e){var t=this.getSpaPlaceHolder().attributes["data-dotvvm-spacontentplaceholder-urlprefix"];if(!t)return e;var r=t.value;return r!==document.location.pathname&&(""===r&&(r="/"),e=r+e),e},e.prototype.removeVirtualDirectoryFromUrl=function(e,t){var r="/"+this.viewModels[t].virtualDirectory;return 0==e.indexOf(r)?this.addLeadingSlash(e.substring(r.length)):e},e.prototype.addLeadingSlash=function(e){return 0<e.length&&"/"!=e.substring(0,1)?"/"+e:e},e.prototype.concatUrl=function(e,t){return 0<e.length&&"/"==e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e+this.addLeadingSlash(t)},e.prototype.patch=function(r,e){var n=this;if(r instanceof Array&&e instanceof Array)return e.map(function(e,t){return n.patch(r[t],e)});if(r instanceof Array||e instanceof Array)return e;if("object"!=typeof r||"object"!=typeof e||!r||!e)return e;for(var t in e)null==e[t]?r[t]=null:null==r[t]?r[t]=e[t]:r[t]=this.patch(r[t],e[t]);return r},e.prototype.updateDynamicPathFragments=function(e,t){for(var r=t.length-1;0<=r;r--)0<=t[r].indexOf("[$index]")&&(t[r]=t[r].replace("[$index]","["+e.$index()+"]")),0<=t[r].indexOf("[$indexPath]")&&(t[r]=t[r].replace("[$indexPath]","["+e.$indexPath.map(function(e){return e()}).join("]/[")+"]")),e=e.$parentContext},e.prototype.postJSON=function(e,t,r,n,o,a){void 0===a&&(a=function(e){});var i=this.getXHR();i.open(t,e,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("X-DotVVM-PostBack","true"),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),a(i),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&(i.status&&i.status<400?n(i):o(i))},i.send(r)},e.prototype.getJSON=function(e,t,r,n,o){var a=this.getXHR();a.open(t,e,!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-DotVVM-SpaContentPlaceHolder",r),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&(a.status&&a.status<400?n(a):o(a))},a.send()},e.prototype.getXHR=function(){return XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP")},e.prototype.cleanUpdatedControls=function(e,t){for(var r in void 0===t&&(t={}),e.updatedControls)if(e.updatedControls.hasOwnProperty(r)){var n=document.getElementByDotvvmId(r);if(n){var o=ko.contextFor(n),a=n.nextSibling,i=n.parentNode;ko.removeNode(n),t[r]={control:n,nextSibling:a,parent:i,dataContext:o}}}return t},e.prototype.restoreUpdatedControls=function(r,n,e){var o=this;for(var t in r.updatedControls)if(r.updatedControls.hasOwnProperty(t)){var a=n[t];if(a){var i=document.createElement(n[t].parent.tagName||"div");if(i.innerHTML=r.updatedControls[t],1<i.childElementCount)throw new Error("Postback.Update control can not render more than one element");var s=i.firstElementChild;if(null==s.id)throw new Error("Postback.Update control always has to render id attribute.");s.id!==n[t].control.id&&console.log("Postback.Update control changed id from '"+n[t].control.id+"' to '"+s.id+"'"),i.removeChild(s),a.nextSibling?a.parent.insertBefore(s,a.nextSibling):a.parent.appendChild(s)}}e&&window.setTimeout(function(){try{for(var e in o.isViewModelUpdating=!0,r.updatedControls){var t=document.getElementByDotvvmId(e);t&&ko.applyBindings(n[e].dataContext,t)}}finally{o.isViewModelUpdating=!1}},0)},e.prototype.unwrapArrayExtension=function(e){return ko.unwrap(ko.unwrap(e))},e.prototype.buildRouteUrl=function(e,i){var t=(e="/"+e).replace(/(\/[^\/]*?)\{([^\}]+?)\??(:(.+?))?\}/g,function(e,t,r,n,o){if(!r)return"";var a=ko.unwrap(i[r.toLowerCase()]);return null==a?"":t+a});return 0===t.indexOf("/")?t.substring(1):t},e.prototype.buildUrlSuffix=function(e,t){var r,n;for(var o in n=-1!==e.indexOf("#")?(r=e.substring(0,e.indexOf("#")),e.substring(e.indexOf("#"))):(r=e,""),t)if(t.hasOwnProperty(o)){if(!o)continue;var a=ko.unwrap(t[o]);if(null==a)continue;r=r.concat(-1!==r.indexOf("?")?"&"+o+"="+a:"?"+o+"="+a)}return r.concat(n)},e.prototype.isPostBackProhibited=function(e){return!!(e&&e.tagName&&-1<["a","input","button"].indexOf(e.tagName.toLowerCase())&&e.getAttribute("disabled"))},e.prototype.addKnockoutBindingHandlers=function(){function v(r,n){void 0===n&&(n=null);var e=ko.pureComputed({read:function(){var e=r();return ko.unwrap(e)},write:function(e){var t=r();ko.isObservable(t)?t(e):console.warn("Attempted to write to readonly property"+(null==n?"":" "+n)+".")}});return e.wrappedProperty=r,e}ko.virtualElements.allowedBindings.dotvvm_withControlProperties=!0,ko.bindingHandlers.dotvvm_withControlProperties={init:function(e,t,r,n,o){if(!o)throw new Error;var a=t();for(var i in a)a[i]=v(function(){var e=t()[this.prop];return ko.isObservable(e)?e:dotvvm.serialization.deserialize(e)}.bind({prop:i}),"'"+i+"' at '"+t.toString()+"'");var s=o.extend({$control:a});return e.innerBindingContext=s,ko.applyBindingsToDescendants(s,e),{controlsDescendantBindings:!0}},update:function(e,t,r,n,o){}},ko.virtualElements.allowedBindings.dotvvm_introduceAlias=!0,ko.bindingHandlers.dotvvm_introduceAlias={init:function(e,t,r,n,o){if(!o)throw new Error;var a=t(),i={};for(var s in a){for(var l=s.split("."),u=i;0<l.length-1;0)u=i[l[0]]||(i[l[0]]={});u[l[l.length-1]]=v(function(){return t()[this.prop]}.bind({prop:s}),"'"+s+"' at '"+t.toString()+"'")}var d=o.extend(i);return e.innerBindingContext=d,ko.applyBindingsToDescendants(d,e),{controlsDescendantBindings:!0}}};var e=function(i,s){return function(t,r,e,n,o){if(!o)throw new Error;var a;return ko.computed(function(){var e=r();!a&&ko.computedContext.getDependenciesCount()&&(a=ko.utils.cloneNodes(ko.virtualElements.childNodes(t),!0)),s(e)?(a&&ko.virtualElements.setDomNodeChildren(t,ko.utils.cloneNodes(a)),ko.applyBindingsToDescendants(i(o,e),t)):ko.virtualElements.emptyNode(t)},null,{disposeWhenNodeIsRemoved:t}),{controlsDescendantBindings:!0}}},s="$foreachCollectionSymbol";ko.virtualElements.allowedBindings["dotvvm-SSR-foreach"]=!0,ko.bindingHandlers["dotvvm-SSR-foreach"]={init:e(function(e,t){var r;return e.extend(((r={})[s]=t.data,r))},function(e){return null!=e.data})},ko.virtualElements.allowedBindings["dotvvm-SSR-item"]=!0,ko.bindingHandlers["dotvvm-SSR-item"]={init:function(e,t,r,n,o){if(!o)throw new Error;var a=o[s],i=o.createChildContext(function(){return ko.unwrap((ko.unwrap(a)||[])[t()])}).extend({$index:ko.pureComputed(t)});return e.innerBindingContext=i,ko.applyBindingsToDescendants(i,e),{controlsDescendantBindings:!0}},update:function(e){e.seenUpdate&&console.error("dotvvm-SSR-item binding did not expect to see a update"),e.seenUpdate=1}},ko.virtualElements.allowedBindings.withGridViewDataSet=!0,ko.bindingHandlers.withGridViewDataSet={init:e(function(e,t){var r;return e.extend(((r={$gridViewDataSet:t})[s]=dotvvm.evaluator.getDataSourceItems(t),r))},function(e){return!0})},ko.bindingHandlers.dotvvmEnable={update:function(e,t){var r=ko.utils.unwrapObservable(t());r&&e.disabled?(e.disabled=!1,e.removeAttribute("disabled")):r||e.disabled||(e.disabled=!0,e.setAttribute("disabled","disabled"))}},ko.bindingHandlers["dotvvm-checkbox-updateAfterPostback"]={init:function(e,t,n,r,o){dotvvm.events.afterPostback.subscribe(function(e){var t=n();if(t["dotvvm-checked-pointer"]){var r=t[t["dotvvm-checked-pointer"]];ko.isObservable(r)&&(r.valueHasMutated?r.valueHasMutated():r.notifySubscribers())}})}},ko.bindingHandlers["dotvvm-checked-pointer"]={init:function(e,t,r,n,o){}},ko.bindingHandlers["dotvvm-UpdateProgress-Visible"]={init:function(n,e,t,r,o){n.style.display="none";var a,i=n.getAttribute("data-delay"),s=(n.getAttribute("data-included-queues")||"").split(",").filter(function(e){return 0<e.length}),l=(n.getAttribute("data-excluded-queues")||"").split(",").filter(function(e){return 0<e.length}),u=!1;dotvvm.updateProgressChangeCounter.subscribe(function(e){var t=!1;if(0===s.length){for(var r in dotvvm.postbackQueues)if(l.indexOf(r)<0&&0<dotvvm.postbackQueues[r].noRunning){t=!0;break}}else t=s.some(function(e){return dotvvm.postbackQueues[e]&&0<dotvvm.postbackQueues[e].noRunning});t?u||(u=!0,null==i?n.style.display="":a=setTimeout(function(e){n.style.display=""},i)):(u=!1,clearTimeout(a),n.style.display="none")})}},ko.bindingHandlers["dotvvm-table-columnvisible"]={init:function(e,t,r,n,o){var a="",i=!0;if(e instanceof HTMLTableCellElement){for(var s=e;!(s instanceof HTMLTableElement);)s=s.parentElement;var l=s.rows.item(0);if(!l)throw Error("Table with dotvvm-table-columnvisible binding handler must not be empty.");var u=[].slice.call(l.cells).indexOf(e);e.dotvvmChangeVisibility=function(e,t,r){if(i!=r){i=r;for(var n=0;n<e.rows.length;n++){var o=e.rows.item(n).cells[t].style;r?o.display=a:(a=o.display||"",o.display="none")}}}.bind(null,s,u)}},update:function(e,t){e.dotvvmChangeVisibility(ko.unwrap(t()))}},ko.bindingHandlers["dotvvm-textbox-text"]={init:function(n,e,t,r,o){var a=e(),i=(t.get("valueUpdate"),new DotvvmValidationElementMetadata);i.element=n,i.dataType=(n.attributes["data-dotvvm-value-type"]||{value:""}).value,i.format=(n.attributes["data-dotvvm-format"]||{value:""}).value;var s=null;s=ko.isObservable(a)?(a.dotvvmMetadata?(a.dotvvmMetadata.elementsMetadata||(a.dotvvmMetadata.elementsMetadata=[]),a.dotvvmMetadata.elementsMetadata.push(i)):(a.dotvvmMetadata=new DotvvmValidationObservableMetadata,a.dotvvmMetadata.elementsMetadata=[i]),a.dotvvmMetadata.elementsMetadata):new DotvvmValidationObservableMetadata,setTimeout(function(n,o){ko.utils.domNodeDisposal.addDisposeCallback(o,function(){for(var e=0,t=n;e<t.length;e++){var r=t[e];if(r.element===o){n.splice(n.indexOf(r),1);break}}})},0,s,n),dotvvm.domUtils.attachEvent(n,"change",function(){if(ko.isObservable(a)){var e,t;if("datetime"===i.dataType){var r=a();null!=r&&(r=dotvvm.globalize.parseDotvvmDate(r)),t=null==(e=dotvvm.globalize.parseDate(n.value,i.format,r))?null:dotvvm.serialization.serializeDate(e,!1)}else t=null===(e=dotvvm.globalize.parseNumber(n.value))||isNaN(e)?null:e;null==t&&null!==n.value&&""!==n.value?(n.attributes["data-invalid-value"]=n.value,n.attributes["data-dotvvm-value-type-valid"]=!1,i.elementValidationState=!1):(n.attributes["data-invalid-value"]=null,n.attributes["data-dotvvm-value-type-valid"]=!0,i.elementValidationState=!0),a()===t?a.valueHasMutated?a.valueHasMutated():a.notifySubscribers():a(t)}})},update:function(e,t,r,n,o){var a=t(),i=(e.attributes["data-dotvvm-format"]||{value:""}).value,s=ko.unwrap(a);if(i){var l=dotvvm.globalize.formatString(i,s),u=e.attributes["data-invalid-value"];if(null==u){if(e.value=l||"",a.dotvvmMetadata&&a.dotvvmMetadata.elementsMetadata)for(var d=0,v=a.dotvvmMetadata.elementsMetadata;d<v.length;d++){var c=v[d];c.element===e&&(e.attributes["data-dotvvm-value-type-valid"]=!0,c.elementValidationState=!0)}}else e.attributes["data-invalid-value"]=null,e.value=u}else e.value=s}},ko.bindingHandlers["dotvvm-textbox-select-all-on-focus"]={init:function(e,t,r,n,o){e.$selectAllOnFocusHandler=function(){e.select()}},update:function(e,t,r,n,o){!0===ko.unwrap(t())?e.addEventListener("focus",e.$selectAllOnFocusHandler):e.removeEventListener("focus",e.$selectAllOnFocusHandler)}},ko.bindingHandlers["dotvvm-CheckState"]={init:function(e,t,r,n,o){ko.getBindingHandler("checked").init(e,t,r,n,o)},update:function(e,t,r){var n=ko.unwrap(t());e.indeterminate=null==n}}},e}(),DotvvmValidationContext=function(e,t,r){this.valueToValidate=e,this.parentViewModel=t,this.parameters=r},DotvvmValidationObservableMetadata=function(){},DotvvmValidationElementMetadata=function(){this.elementValidationState=!0},DotvvmValidatorBase=function(){function e(){}return e.prototype.isValid=function(e,t){return!1},e.prototype.isEmpty=function(e){return null==e||"string"==typeof e&&""===e.trim()},e.prototype.getValidationMetadata=function(e){return e.dotvvmMetadata},e}(),DotvvmRequiredValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate;return!this.isEmpty(t)},t}(DotvvmValidatorBase),DotvvmRegularExpressionValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate,r=e.parameters[0];return this.isEmpty(t)||new RegExp(r).test(t)},t}(DotvvmValidatorBase),DotvvmIntRangeValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate,r=e.parameters[0],n=e.parameters[1];return t%1==0&&r<=t&&t<=n},t}(DotvvmValidatorBase),DotvvmEnforceClientFormatValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e,t){var r=!0;e.parameters[0]||null!=e.valueToValidate||(r=!1),e.parameters[1]||0!==e.valueToValidate.length||(r=!1),!e.parameters[2]&&this.isEmpty(e.valueToValidate)&&(r=!1);var n=this.getValidationMetadata(t);if(n&&n.elementsMetadata)for(var o=0,a=n.elementsMetadata;o<a.length;o++){a[o].elementValidationState||(r=!1)}return r},t}(DotvvmValidatorBase),DotvvmRangeValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e,t){var r=e.valueToValidate,n=e.parameters[0],o=e.parameters[1];return n<=r&&r<=o},t}(DotvvmValidatorBase),DotvvmNotNullValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){return null!==e.valueToValidate&&void 0!==e.valueToValidate},t}(DotvvmValidatorBase),DotvvmEmailAddressValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate;if(null==t)return!0;if("string"!=typeof t)return!1;for(var r=!1,n=0;n<t.length;n++)if("@"==t[n]){if(r||0==n||n==t.length-1)return!1;r=!0}return r},t}(DotvvmValidatorBase),ErrorsPropertyName="validationErrors",ValidationError=function(){function n(e,t){this.errorMessage=e,this.validatedObservable=t}return n.attach=function(e,t){if(!e)throw new Error('String "'+e+'" is not a valid ValidationError message.');if(!t)throw new Error('ValidationError cannot be attached to "'+t+'".');"wrappedProperty"in t&&(t=t.wrappedProperty()),t.hasOwnProperty(ErrorsPropertyName)||(t[ErrorsPropertyName]=[]);var r=new n(e,t);return t[ErrorsPropertyName].push(r),dotvvm.validation.errors.push(r),r},n.prototype.detach=function(){var e=this.validatedObservable.validationErrors.indexOf(this);this.validatedObservable.validationErrors.splice(e,1);var t=dotvvm.validation.errors.indexOf(this);dotvvm.validation.errors.splice(t,1)},n}(),DotvvmValidation=function(){function u(s){var a=this;this.rules={required:new DotvvmRequiredValidator,regularExpression:new DotvvmRegularExpressionValidator,intrange:new DotvvmIntRangeValidator,range:new DotvvmRangeValidator,emailAddress:new DotvvmEmailAddressValidator,notnull:new DotvvmNotNullValidator,enforceClientFormat:new DotvvmEnforceClientFormatValidator},this.errors=[],this.events={validationErrorsChanged:new DotvvmEvent("dotvvm.validation.events.validationErrorsChanged")},this.elementUpdateFunctions={hideWhenValid:function(e,t,r){0<t.length?e.style.display="":e.style.display="none"},invalidCssClass:function(e,t,r){for(var n=r.split(/\s+/).filter(function(e){return 0<e.length}),o=0;o<n.length;o++){var a=n[o];0<t.length?e.classList.add(a):e.classList.remove(a)}},setToolTipText:function(e,t,r){0<t.length?e.title=t.join(" "):e.title=""},showErrorMessageText:function(e,t,r){e[e.innerText?"innerText":"textContent"]=t.join(" ")}};var t=function(o){return{execute:function(e,t){if(o){t.additionalPostbackData.validationTargetPath=o;var r=ko.contextFor(t.sender),n=s.evaluator.evaluateOnViewModel(r,o);if(a.detachAllErrors(),a.validateViewModel(n),a.events.validationErrorsChanged.trigger({viewModel:t.viewModel}),0<a.errors.length)return console.log("Validation failed: postback aborted; errors: ",a.errors),Promise.reject({type:"handler",handler:a,message:"Validation failed"})}return e()}}};s.postbackHandlers.validate=function(e){return t(e.path)},s.postbackHandlers["validate-root"]=function(){return t("dotvvm.viewModelObservables['root']")},s.postbackHandlers["validate-this"]=function(){return t("$data")},s.events.afterPostback.subscribe(function(e){!e.wasInterrupted&&e.serverResponseObject&&("successfulCommand"===e.serverResponseObject.action?(a.mergeValidationRules(e),e.isHandled=!0):"validationErrors"===e.serverResponseObject.action&&(a.detachAllErrors(),a.showValidationErrorsFromServer(e),a.events.validationErrorsChanged.trigger(e),e.isHandled=!0))}),s.events.spaNavigating.subscribe(function(e){a.detachAllErrors(),a.events.validationErrorsChanged.trigger({viewModel:e.viewModel})}),ko.bindingHandlers.dotvvmValidation={init:function(t,r,n){s.validation.events.validationErrorsChanged.subscribe(function(e){a.applyValidatorOptions(t,r(),n.get("dotvvmValidationOptions"))})},update:function(e,t,r){a.applyValidatorOptions(e,t(),r.get("dotvvmValidationOptions"))}},ko.bindingHandlers["dotvvm-validationSummary"]={init:function(a,e){var i=e();s.validation.events.validationErrorsChanged.subscribe(function(e){a.innerHTML="";for(var t=0,r=s.validation.getValidationErrors(i.target,i.includeErrorsFromChildren,i.includeErrorsFromTarget);t<r.length;t++){var n=r[t],o=document.createElement("li");o.innerText=n.errorMessage,a.appendChild(o)}})}}}return u.prototype.validateViewModel=function(e){if(ko.isObservable(e)&&(e=ko.unwrap(e)),e){var t=(dotvvm.viewModels.root.validationRules||{})[ko.unwrap(e.$type)]||{};for(var r in e)if(e.hasOwnProperty(r)&&0!==r.indexOf("$")){var n=e[r];if(n&&ko.isObservable(n)){var o=n();t.hasOwnProperty(r)&&this.validateProperty(e,n,o,t[r]);var a=e[r+"$options"];if(a&&a.type&&!u.hasErrors(n)&&!dotvvm.serialization.validateType(o,a.type)&&ValidationError.attach("The value of property "+r+" ("+o+") is invalid value for type "+a.type+".",n),o)if(Array.isArray(o))for(var i=0,s=o;i<s.length;i++){var l=s[i];this.validateViewModel(l)}else o&&o instanceof Object&&this.validateViewModel(o)}}}},u.prototype.validateProperty=function(e,t,r,n){for(var o=0,a=n;o<a.length;o++){var i=a[o],s=this.rules[i.ruleName],l=new DotvvmValidationContext(r,e,i.parameters);s.isValid(l,t)||ValidationError.attach(i.errorMessage,t)}},u.prototype.mergeValidationRules=function(e){if(e.serverResponseObject.validationRules){var t=dotvvm.viewModels[e.viewModelName].validationRules;for(var r in void 0===t&&(dotvvm.viewModels[e.viewModelName].validationRules={},t=dotvvm.viewModels[e.viewModelName].validationRules),e.serverResponseObject.validationRules)e.serverResponseObject.validationRules.hasOwnProperty(r)&&(t[r]=e.serverResponseObject.validationRules[r])}},u.prototype.clearValidationErrors=function(e){if(e&&ko.isObservable(e)){if(e[ErrorsPropertyName])for(var t=0,r=e[ErrorsPropertyName].concat([]);t<r.length;t++){r[t].detach()}var n=ko.unwrap(e);if(n){if(Array.isArray(n))for(var o=0,a=n;o<a.length;o++){var i=a[o];this.clearValidationErrors(i)}for(var s in n)if(n.hasOwnProperty(s)&&0!==s.indexOf("$")){var l=n[s];this.clearValidationErrors(l)}}}},u.prototype.detachAllErrors=function(){for(;0<this.errors.length;)this.errors[0].detach()},u.prototype.getValidationErrors=function(e,t,r,n){if(void 0===n&&(n=!0),!e)return[];var o=[];if(r&&e.hasOwnProperty(ErrorsPropertyName)&&(o=o.concat(e[ErrorsPropertyName])),!n)return o;var a=ko.unwrap(e);if(Array.isArray(a)){for(var i=0,s=a;i<s.length;i++){var l=s[i];o=o.concat(this.getValidationErrors(l,t,!0,t))}return o}for(var u in a)if(a.hasOwnProperty(u)&&0!==u.indexOf("$")){var d=a[u];d&&ko.isObservable(d)&&(o=o.concat(this.getValidationErrors(d,t,!0,t)))}return o},u.prototype.showValidationErrorsFromServer=function(e){var t=ko.contextFor(e.sender),r=dotvvm.evaluator.evaluateOnViewModel(t,e.postbackOptions.additionalPostbackData.validationTargetPath);if(r)for(var n=e.serverResponseObject.modelState,o=0;o<n.length;o++){var a,i=n[o].propertyPath;a=i?(ko.isObservable(r)&&(r=ko.unwrap(r)),dotvvm.evaluator.evaluateOnViewModel(r,i)):r,ValidationError.attach(n[o].errorMessage,a)}},u.hasErrors=function(e){return"wrappedProperty"in e&&(e=e.wrappedProperty()),e.hasOwnProperty(ErrorsPropertyName)&&0<e[ErrorsPropertyName].length},u.prototype.applyValidatorOptions=function(e,t,r){if(ko.isObservable(t)){"wrappedProperty"in t&&(t=t.wrappedProperty());var n=(t[ErrorsPropertyName]||[]).map(function(e){return e.errorMessage});for(var o in r)r.hasOwnProperty(o)&&dotvvm.validation.elementUpdateFunctions[o](e,n,r[o])}},u}(),DotvvmEvaluator=function(){function DotvvmEvaluator(){}return DotvvmEvaluator.prototype.evaluateOnViewModel=function(context,expression){var result;return result=context&&context.$data?eval("(function ($context) { with($context) { with ($data) { return "+expression+"; } } })")(context):eval("(function ($context) { var $data=$context; with($context) { return "+expression+"; } })")(context),result&&result.$data&&(result=result.$data),result},DotvvmEvaluator.prototype.evaluateOnContext=function(e,t){var r=!1;for(var n in e)if(0===t.indexOf(n)){r=!0;break}return r||(t="$data."+t),this.evaluateOnViewModel(e,t)},DotvvmEvaluator.prototype.getDataSourceItems=function(e){var t=ko.unwrap(e);return void 0===t||null==t?[]:ko.unwrap(t.Items||t)},DotvvmEvaluator.prototype.tryEval=function(e){try{return e()}catch(e){return null}},DotvvmEvaluator.prototype.isObservableArray=function(e){return ko.isComputed(e)?Array.isArray(e.peek()):!!ko.isObservable(e)&&"push"in e},DotvvmEvaluator.prototype.wrapObservable=function(r,e){var n=this,t=ko.pureComputed({read:function(){return ko.unwrap(n.getExpressionResult(r))},write:function(e){return n.updateObservable(r,e)}});return e&&(t.push=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"push",e)},t.pop=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"pop",e)},t.unshift=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"unshift",e)},t.shift=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"shift",e)},t.reverse=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"reverse",e)},t.sort=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"sort",e)},t.splice=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"splice",e)},t.slice=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"slice",e)},t.replace=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"replace",e)},t.indexOf=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"indexOf",e)},t.remove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"remove",e)},t.removeAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"removeAll",e)},t=t.extend({trackArrayChanges:!0})),t.extend({notify:"always"})},DotvvmEvaluator.prototype.updateObservable=function(e,t){var r=this.getExpressionResult(e);ko.isWriteableObservable(r)?r(t):console.error("Cannot write a value to ko.computed because the expression '"+e+"' does not return a writable observable.")},DotvvmEvaluator.prototype.updateObservableArray=function(e,t,r){var n=this.getExpressionResult(e);this.isObservableArray(n)?n[t].apply(n,r):console.error("Cannot execute '"+t+"' function on ko.computed because the expression '"+e+"' does not return an observable array.")},DotvvmEvaluator.prototype.getExpressionResult=function(e){var t=e();return ko.isComputed(t)&&"wrappedProperty"in t&&(t=t.wrappedProperty()),t},DotvvmEvaluator}(),DotvvmEventHub=function(){function e(){this.map={}}return e.prototype.notify=function(e){e in this.map?this.map[e].notifySubscribers():this.map[e]=ko.observable(0)},e.prototype.get=function(e){return this.map[e]||(this.map[e]=ko.observable(0))},e}();function basicAuthenticatedFetch(t,r){var n=sessionStorage.getItem("someAuth");return null!=n&&(null==r&&(r={}),null==r.headers&&(r.headers={}),null==r.headers.Authorization&&(r.headers.Authorization="Basic "+btoa(n))),null==r&&(r={}),r.cache||(r.cache="no-cache"),window.fetch(t,r).then(function(e){return 401===e.status&&null==n?(null==sessionStorage.getItem("someAuth")&&function(){var e=prompt("You credentials for "+(t.url||t))||"";sessionStorage.setItem("someAuth",e)}(),basicAuthenticatedFetch(t,r)):e})}!function(){var i={};DotVVM.prototype.invokeApiFn=function(r,e,o,t){void 0===e&&(e=[]),void 0===o&&(o=[]),void 0===t&&(t=r.toString());var a=i[t]||(i[t]=ko.observable(null)),n=ko.pureComputed(function(){return a()});return n.refreshValue=function(e){var t=a.promise;if(a.isLoading||(a.isLoading=!0,t=function(){try{return{type:"result",result:window.Promise.resolve(ko.ignoreDependencies(r)).then(function(e){e&&(a(ko.unwrap(dotvvm.serialization.deserialize(e,a))),a.notifySubscribers());for(var t=0,r=o;t<r.length;t++){var n=r[t];dotvvm.eventHub.notify(n)}return e},console.warn)}}catch(e){return console.warn(e),{type:"error",error:e}}}(),a.promise=t),"error"!=t.type)return t.result.then(function(e){return a.isLoading=!1},function(e){return a.isLoading=!1}),t.result;if(a.isLoading=!1,e)throw t.error},a.peek()||n.refreshValue(),ko.computed(function(){return e.map(function(e){return"string"==typeof e?dotvvm.eventHub.get(e)():e()})}).subscribe(function(e){return n.refreshValue()}),n},DotVVM.prototype.apiRefreshOn=function(e,t){return"function"!=typeof e.refreshValue&&console.error("The object is not refreshable"),t.subscribe(function(){"function"!=typeof e.refreshValue&&console.error("The object is not refreshable"),e.refreshValue&&e.refreshValue()}),e},DotVVM.prototype.api={},DotVVM.prototype.eventHub=new DotvvmEventHub}();
=======
var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(i,a,s,l){return new(s||(s=Promise))(function(e,t){function r(e){try{o(l.next(e))}catch(e){t(e)}}function n(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,n)}o((l=l.apply(i,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};!function(){if("undefined"==typeof Promise||!self.fetch){var e=document.createElement("script");e.src=window.dotvvm__polyfillUrl,e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)}}();var DotvvmDomUtils=function(){function e(){}return e.prototype.onDocumentReady=function(e){/in/.test(document.readyState)?setTimeout("dotvvm.domUtils.onDocumentReady("+e+")",9):e()},e.prototype.attachEvent=function(e,t,r,n){void 0===n&&(n=!1),e.addEventListener?e.addEventListener(t,r,n):e.attachEvent("on"+t,r)},e}(),HistoryRecord=function(e,t){this.navigationType=e,this.url=t},DotvvmSpaHistory=function(){function e(){}return e.prototype.pushPage=function(e){history.pushState(new HistoryRecord("SPA",e),"",e)},e.prototype.replacePage=function(e){history.replaceState(new HistoryRecord("SPA",e),"",e)},e.prototype.isSpaPage=function(e){return e&&"SPA"==e.navigationType},e.prototype.getHistoryRecord=function(e){return e},e}(),DotvvmEvents=function(){this.init=new DotvvmEvent("dotvvm.events.init",!0),this.beforePostback=new DotvvmEvent("dotvvm.events.beforePostback"),this.afterPostback=new DotvvmEvent("dotvvm.events.afterPostback"),this.error=new DotvvmEvent("dotvvm.events.error"),this.spaNavigating=new DotvvmEvent("dotvvm.events.spaNavigating"),this.spaNavigated=new DotvvmEvent("dotvvm.events.spaNavigated"),this.redirect=new DotvvmEvent("dotvvm.events.redirect"),this.postbackHandlersStarted=new DotvvmEvent("dotvvm.events.postbackHandlersStarted"),this.postbackHandlersCompleted=new DotvvmEvent("dotvvm.events.postbackHandlersCompleted"),this.postbackResponseReceived=new DotvvmEvent("dotvvm.events.postbackResponseReceived"),this.postbackCommitInvoked=new DotvvmEvent("dotvvm.events.postbackCommitInvoked"),this.postbackViewModelUpdated=new DotvvmEvent("dotvvm.events.postbackViewModelUpdated"),this.postbackRejected=new DotvvmEvent("dotvvm.events.postbackRejected"),this.staticCommandMethodInvoking=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoking"),this.staticCommandMethodInvoked=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoked"),this.staticCommandMethodFailed=new DotvvmEvent("dotvvm.events.staticCommandMethodInvoked")},DotvvmEventHandler=function(e,t){this.handler=e,this.isOneTime=t},DotvvmEvent=function(){function e(e,t){void 0===t&&(t=!1),this.name=e,this.triggerMissedEventsOnSubscribe=t,this.handlers=[],this.history=[]}return e.prototype.subscribe=function(e){if(this.handlers.push(new DotvvmEventHandler(e,!1)),this.triggerMissedEventsOnSubscribe)for(var t=0;t<this.history.length;t++)e(history[t])},e.prototype.subscribeOnce=function(e){this.handlers.push(new DotvvmEventHandler(e,!0))},e.prototype.unsubscribe=function(e){for(var t=0;t<this.handlers.length;t++)if(this.handlers[t].handler===e)return void this.handlers.splice(t,1)},e.prototype.trigger=function(e){for(var t=0;t<this.handlers.length;t++)this.handlers[t].handler(e),this.handlers[t].isOneTime&&(this.handlers.splice(t,1),t--);this.triggerMissedEventsOnSubscribe&&this.history.push(e)},e}(),DotvvmErrorEventArgs=function(e,t,r,n,o,i,a){void 0===i&&(i=void 0),void 0===a&&(a=!1),this.sender=e,this.viewModel=t,this.viewModelName=r,this.xhr=n,this.postbackClientId=o,this.serverResponseObject=i,this.isSpaNavigationError=a,this.handled=!1},DotvvmBeforePostBackEventArgs=function(e,t,r,n){this.sender=e,this.viewModel=t,this.viewModelName=r,this.postbackClientId=n,this.cancel=!1,this.clientValidationFailed=!1},DotvvmAfterPostBackEventArgs=function(){function e(e,t,r,n){void 0===r&&(r=null),this.postbackOptions=e,this.serverResponseObject=t,this.commandResult=r,this.xhr=n,this.isHandled=!1,this.wasInterrupted=!1}return Object.defineProperty(e.prototype,"postbackClientId",{get:function(){return this.postbackOptions.postbackId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewModelName",{get:function(){return this.postbackOptions.viewModelName},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewModel",{get:function(){return this.postbackOptions.viewModel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sender",{get:function(){return this.postbackOptions.sender},enumerable:!0,configurable:!0}),e}(),DotvvmAfterPostBackWithRedirectEventArgs=function(a){function e(e,t,r,n,o){void 0===r&&(r=null);var i=a.call(this,e,t,r,n)||this;return i._redirectPromise=o,i}return __extends(e,a),Object.defineProperty(e.prototype,"redirectPromise",{get:function(){return this._redirectPromise},enumerable:!0,configurable:!0}),e}(DotvvmAfterPostBackEventArgs),DotvvmSpaNavigatingEventArgs=function(e,t,r){this.viewModel=e,this.viewModelName=t,this.newUrl=r,this.cancel=!1},DotvvmNavigationEventArgs=function(e,t,r,n){this.viewModel=e,this.viewModelName=t,this.serverResponseObject=r,this.xhr=n,this.isHandled=!1},DotvvmSpaNavigatedEventArgs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(DotvvmNavigationEventArgs),DotvvmRedirectEventArgs=function(e,t,r,n){this.viewModel=e,this.viewModelName=t,this.url=r,this.replace=n,this.isHandled=!1},DotvvmFileUpload=function(){function e(){}return e.prototype.showUploadDialog=function(e){var t=this.getIframe(e);this.createUploadId(e,t),this.openUploadDialog(t)},e.prototype.getIframe=function(e){return e.parentElement.previousSibling},e.prototype.openUploadDialog=function(e){var t=e.contentWindow;t&&t.document.getElementById("upload").click()},e.prototype.createUploadId=function(e,t){t=t||this.getIframe(e);var r="DotVVM_upl"+(new Date).getTime().toString();e.parentElement.parentElement.setAttribute("data-dotvvm-upload-id",r),t.setAttribute("data-dotvvm-upload-id",r)},e.prototype.reportProgress=function(e,t,r,n){var o=document.querySelector("div[data-dotvvm-upload-id='"+e.value+"']"),i=ko.dataFor(o.firstChild);if("string"==typeof n)i.Error(n);else{i.Error("");for(var a=0;a<n.length;a++)i.Files.push(dotvvm.serialization.wrapObservable(dotvvm.serialization.deserialize(n[a])));(o.attributes["data-dotvvm-upload-completed"]||{value:null}).value&&new Function(o.attributes["data-dotvvm-upload-completed"].value).call(o)}i.Progress(r),i.IsBusy(t)},e}(),DotvvmFileUploadCollection=function(){this.Files=ko.observableArray(),this.Progress=ko.observable(0),this.Error=ko.observable(),this.IsBusy=ko.observable()},DotvvmFileUploadData=function(){this.FileId=ko.observable(),this.FileName=ko.observable(),this.FileSize=ko.observable(),this.IsFileTypeAllowed=ko.observable(),this.IsMaxSizeExceeded=ko.observable(),this.IsAllowed=ko.observable()},DotvvmFileSize=function(){this.Bytes=ko.observable(),this.FormattedText=ko.observable()},DotvvmGlobalize=function(){function e(){}return e.prototype.getGlobalize=function(){var e=window.dotvvm_Globalize;if(!e)throw new Error("Resource 'globalize' is not included (symbol 'dotvvm_Globalize' could not be found).\nIt is usually included automatically when needed, but sometime it's not possible, so you will have to include it in your page using '<dot:RequiredResource Name=\"globalize\" />'");return e},e.prototype.format=function(e){for(var o=this,i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];return e.replace(/\{([1-9]?[0-9]+)(:[^}]+)?\}/g,function(e,t,r){var n=i[parseInt(t)];return r?o.formatString(r,n):n})},e.prototype.formatString=function(e,t){if(null==(t=ko.unwrap(t))||""===t)return"";if("string"==typeof t&&null==(t=this.parseDotvvmDate(t)))throw new Error("Could not parse "+t+" as a date");return""!==e&&null!==e||(e="G"),this.getGlobalize().format(t,e,dotvvm.culture)},e.prototype.parseDotvvmDate=function(e){var t=e.match("^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]{3,7})$");return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3]),parseInt(t[4]),parseInt(t[5]),parseInt(t[6]),7<t.length?parseInt(t[7].substring(1,4)):0):null},e.prototype.parseNumber=function(e){return this.getGlobalize().parseFloat(e,10,dotvvm.culture)},e.prototype.parseDate=function(e,t,r){return this.getGlobalize().parseDate(e,t,dotvvm.culture,r)},e.prototype.bindingDateToString=function(t,r){var n=this;if(void 0===r&&(r="G"),!t)return"";var o=function(){var e=ko.unwrap(t);return"string"==typeof e?n.parseDotvvmDate(e):e},e=function(){var e=o();return null!=e?n.getGlobalize().format(e,r,dotvvm.culture):""};if(ko.isWriteableObservable(t)){var i="string"==typeof o()?function(e){return t(null==e?null:dotvvm.serialization.serializeDate(e,!1))}:t;return ko.pureComputed({read:function(){return e()},write:function(e){return i(n.getGlobalize().parseDate(e,r,dotvvm.culture))}})}return ko.pureComputed(function(){return e()})},e.prototype.bindingNumberToString=function(n,t){var o=this;if(void 0===t&&(t="G"),null==n)return"";var e=function(){var e=function(){var e=ko.unwrap(n);return"string"==typeof e?o.parseNumber(e):e}();return null!=e?o.getGlobalize().format(e,t,dotvvm.culture):""};return ko.isWriteableObservable(n)?ko.pureComputed({read:function(){return e()},write:function(e){var t=o.getGlobalize().parseFloat(e,10,dotvvm.culture),r=null==e||null!=t&&!isNaN(t);n(r?t:null)}}):ko.pureComputed(function(){return e()})},e}(),PostbackOptions=function(e,t,r,n,o){void 0===r&&(r=[]),this.postbackId=e,this.sender=t,this.args=r,this.viewModel=n,this.viewModelName=o,this.additionalPostbackData={}},ConfirmPostBackHandler=function(){function e(e){this.message=e}return e.prototype.execute=function(r,e){var n=this;return new Promise(function(e,t){confirm(n.message)?r().then(e,t):t({type:"handler",handler:n,message:"The postback was not confirmed"})})},e}(),SuppressPostBackHandler=function(){function e(e){this.suppress=e}return e.prototype.execute=function(r,e){var n=this;return new Promise(function(e,t){n.suppress?t({type:"handler",handler:n,message:"The postback was suppressed"}):r().then(e,t)})},e}(),DotvvmSerialization=function(){function e(){}return e.prototype.wrapObservable=function(e){return ko.isObservable(e)?e:ko.observable(e)},e.prototype.deserialize=function(e,t,r){if(void 0===r&&(r=!1),ko.isObservable(e))throw new Error("Parameter viewModel should not be an observable. Maybe you forget to invoke the observable you are passing as a viewModel parameter.");return this.isPrimitive(e)?this.deserializePrimitive(e,t):e instanceof Date?this.deserializeDate(e,t):e instanceof Array?this.deserializeArray(e,t,r):this.deserializeObject(e,t,r)},e.prototype.deserializePrimitive=function(e,t){return ko.isObservable(t)?(t(e),t):e},e.prototype.deserializeDate=function(e,t){return e=dotvvm.serialization.serializeDate(e),ko.isObservable(t)?(t(e),t):e},e.prototype.deserializeArray=function(e,t,r){return void 0===r&&(r=!1),this.isObservableArray(t)&&null!=t()&&t().length===e.length?this.updateArrayItems(e,t,r):t=this.rebuildArrayFromScratch(e,t,r),t},e.prototype.rebuildArrayFromScratch=function(e,t,r){for(var n=[],o=0;o<e.length;o++)n.push(this.wrapObservableObjectOrArray(this.deserialize(ko.unwrap(e[o]),{},r)));return ko.isObservable(t)?(t=this.extendToObservableArrayIfRequired(t))(n):t=n,t},e.prototype.updateArrayItems=function(e,t,r){for(var n=t(),o=0;o<e.length;o++){var i=ko.unwrap(n[o]),a=this.deserialize(ko.unwrap(e[o]),i,r);i!==a&&(ko.isObservable(n[o])?n[o]()!==a&&(n[o]=this.extendToObservableArrayIfRequired(n[o]),n[o](a)):n[o]=this.wrapObservableObjectOrArray(a))}},e.prototype.deserializeObject=function(e,t,r){var n=ko.unwrap(t);this.isPrimitive(n)&&(n={});for(var o=0,i=Object.getOwnPropertyNames(e);o<i.length;o++){var a=i[o];if(!this.isOptionsProperty(a)){var s=e[a];if(void 0!==s&&(ko.isObservable(s)||"function"!=typeof s)){var l=e[a+"$options"]||n&&n[a+"$options"];!r&&l&&l.doNotUpdate||this.copyProperty(s,n,a,r,l)}}}for(var u=0,d=Object.getOwnPropertyNames(e);u<d.length;u++){a=d[u];this.isOptionsProperty(a)&&this.copyPropertyMetadata(n,a,e)}return ko.isObservable(t)?n!==t()&&t(n):t=n,t},e.prototype.copyProperty=function(e,t,r,n,o){var i=this.deserialize(ko.unwrap(e),t[r],n);if(e instanceof Date&&(t[r+"$options"]=__assign({},t[r+"$options"],{isDate:!0})),ko.isObservable(i)?i()!==t[r]()&&(t[r]=this.extendToObservableArrayIfRequired(t[r]),t[r](i())):t[r]=this.wrapObservableObjectOrArray(i),o&&o.clientExtenders&&ko.isObservable(t[r]))for(var a=0;a<o.clientExtenders.length;a++){var s={},l=o.clientExtenders[a];s[l.name]=l.parameter,t[r].extend(s)}},e.prototype.copyPropertyMetadata=function(e,t,r){e[t]=__assign({},e[t],r[t]);var n=t.substring(0,t.length-"$options".length);void 0===e[n]&&(e[n]=ko.observable())},e.prototype.extendToObservableArrayIfRequired=function(e){if(!ko.isObservable(e))throw new Error("Trying to extend a non-observable to an observable array.");return this.isObservableArray(e)||(ko.utils.extend(e,ko.observableArray.fn),e=e.extend({trackArrayChanges:!0})),e},e.prototype.wrapObservableObjectOrArray=function(e){return Array.isArray(e)?ko.observableArray(e):ko.observable(e)},e.prototype.isPrimitive=function(e){return null==e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e},e.prototype.isOptionsProperty=function(e){return/\$options$/.test(e)},e.prototype.isObservableArray=function(e){return ko.isObservable(e)&&"removeAll"in e},e.prototype.serialize=function(e,t){if(void 0===t&&(t={}),(t=ko.utils.extend({},t)).pathOnly&&t.path&&0===t.path.length&&(t.pathOnly=!1),null==e)return null;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;if(ko.isObservable(e))return this.serialize(e(),t);if("function"==typeof e)return null;if(e instanceof Array){if(t.pathOnly&&t.path){var r=parseInt(t.path.pop());return(n=new Array(r+1))[r]=this.serialize(e[r],t),t.path.push(r.toString()),n}for(var n=[],o=0;o<e.length;o++)n.push(this.serialize(e[o],t));return n}if(e instanceof Date)return t.restApiTarget?e:this.serializeDate(e);var i=t.path&&t.path.pop(),a={};for(var s in e)if(e.hasOwnProperty(s)){if(t.pathOnly&&s!==i)continue;var l=e[s];if(t.ignoreSpecialProperties&&"$"===s[0])continue;if(!t.serializeAll&&(/\$options$/.test(s)||"$validationErrors"===s))continue;if(void 0===l)continue;if(!ko.isObservable(l)&&"function"==typeof l)continue;var u=e[s+"$options"];if(!t.serializeAll&&u&&u.doNotPost);else if(t.oneLevel)a[s]=ko.unwrap(l);else if(!t.serializeAll&&u&&u.pathOnly&&t.pathMatcher){var d=u.pathOnly;d instanceof Array||(d=t.path||this.findObject(l,t.pathMatcher)),d&&(0===d.length?a[s]=this.serialize(l,t):a[s]=this.serialize(l,{ignoreSpecialProperties:t.ignoreSpecialProperties,serializeAll:t.serializeAll,path:d,pathOnly:!0}))}else a[s]=this.serialize(l,t);u&&u.type&&!this.validateType(a[s],u.type)&&(delete a[s],u.wasInvalid=!0)}return i&&t.path&&t.path.push(i),a},e.prototype.validateType=function(e,t){var r="?"===t[t.length-1];if(r&&(t=t.substr(0,t.length-1)),r&&(null==e||""==e))return!0;if(!r&&null==e)return!1;var n=/(u?)int(\d*)/.exec(t);if(n){if(!/^-?\d*$/.test(e))return!1;var o="u"===n[1],i=parseInt(n[2]),a=0,s=Math.pow(2,i)-1;o||(s+=a=-Math.floor(s/2));var l=parseInt(e);return a<=l&&l<=s&&l===parseFloat(e)}return"number"!==t&&"single"!==t&&"double"!==t&&"decimal"!==t||(+e===e||!isNaN(+e)&&"string"==typeof e)},e.prototype.findObject=function(e,t){if(t(e))return[];if(t(e=ko.unwrap(e)))return[];if("object"!=typeof e)return null;for(var r in e)if(e.hasOwnProperty(r)){var n=this.findObject(e[r],t);if(n)return n.push(r),n}return null},e.prototype.flatSerialize=function(e){return this.serialize(e,{ignoreSpecialProperties:!0,oneLevel:!0,serializeAll:!0})},e.prototype.getPureObject=function(e){if((e=ko.unwrap(e))instanceof Array)return e.map(this.getPureObject.bind(this));var t={};for(var r in e)"$"!=r[0]&&(t[r]=e[r]);return t},e.prototype.pad=function(e,t){for(;e.length<t;)e="0"+e;return e},e.prototype.serializeDate=function(e,t){if(void 0===t&&(t=!0),null==e)return null;if("string"==typeof e)return null==dotvvm.globalize.parseDotvvmDate(e)&&console.error(new Error("Date "+e+" is invalid.")),e;var r=new Date(e.getTime());return t?r.setMinutes(e.getMinutes()+e.getTimezoneOffset()):r=e,this.pad(r.getFullYear().toString(),4)+"-"+this.pad((r.getMonth()+1).toString(),2)+"-"+this.pad(r.getDate().toString(),2)+"T"+this.pad(r.getHours().toString(),2)+":"+this.pad(r.getMinutes().toString(),2)+":"+this.pad(r.getSeconds().toString(),2)+"."+this.pad(r.getMilliseconds().toString(),3)+"0000"},e}();document.getElementByDotvvmId=function(e){return document.querySelector("[data-dotvvm-id='"+e+"']")};var DotVVM=function(){function e(){var n,i=this;this.postBackCounter=0,this.lastStartedPostack=0,this.resourceSigns={},this.isViewModelUpdating=!0,this.spaHistory=new DotvvmSpaHistory,this.viewModelObservables={},this.isSpaReady=ko.observable(!1),this.viewModels={},this.serialization=new DotvvmSerialization,this.postbackHandlers={confirm:function(e){return new ConfirmPostBackHandler(e.message)},suppress:function(e){return new SuppressPostBackHandler(e.suppress)},timeout:function(e){return e.time?i.createWindowSetTimeoutHandler(e.time):i.windowSetTimeoutHandler},"concurrency-default":function(r){return{name:"concurrency-default",before:["setIsPostbackRunning"],execute:function(e,t){return i.commonConcurrencyHandler(e(),t,r.q||"default")}}},"concurrency-deny":function(n){return{name:"concurrency-deny",before:["setIsPostbackRunning"],execute:function(e,t){var r=n.q||"default";return 0<dotvvm.getPostbackQueue(r).noRunning?Promise.reject({type:"handler",handler:this,message:"An postback is already running"}):dotvvm.commonConcurrencyHandler(e(),t,r)}}},"concurrency-queue":function(o){return{name:"concurrency-queue",before:["setIsPostbackRunning"],execute:function(e,t){var r=o.q||"default",n=function(){return dotvvm.commonConcurrencyHandler(e(),t,r)};return 0<dotvvm.getPostbackQueue(r).noRunning?new Promise(function(e){dotvvm.getPostbackQueue(r).queue.push(function(){return e(n())})}):n()}}},suppressOnUpdating:function(e){return{name:"suppressOnUpdating",before:["setIsPostbackRunning","concurrency-default","concurrency-queue","concurrency-deny"],execute:function(e,t){return dotvvm.isViewModelUpdating?Promise.reject({type:"handler",handler:this,message:"ViewModel is updating, so it's probably false onchange event"}):e()}}}},this.suppressOnDisabledElementHandler={name:"suppressOnDisabledElement",before:["setIsPostbackRunning","concurrency-default","concurrency-queue","concurrency-deny"],execute:function(e,t){return t.sender&&dotvvm.isPostBackProhibited(t.sender)?Promise.reject({type:"handler",handler:i,message:"PostBack is prohibited on disabled element"}):e()}},this.beforePostbackEventPostbackHandler={execute:function(e,t){var r=new DotvvmBeforePostBackEventArgs(t.sender,t.viewModel,t.viewModelName,t.postbackId);return i.events.beforePostback.trigger(r),r.cancel?Promise.reject({type:"event",options:t}):e()}},this.isPostBackRunningHandler=(n=0,{name:"setIsPostbackRunning",before:["eventInvoke-postbackHandlersStarted"],execute:function(e,t){i.isPostbackRunning(!0),n++;var r=e();return r.then(function(){return i.isPostbackRunning(!!--n)},function(){return i.isPostbackRunning(!!--n)}),r}}),this.windowSetTimeoutHandler=this.createWindowSetTimeoutHandler(0),this.commonConcurrencyHandler=function(e,r,t){var n=i.getPostbackQueue(t);n.noRunning++,dotvvm.updateProgressChangeCounter(dotvvm.updateProgressChangeCounter()+1);var o=function(e){var t=function(){if(n.noRunning--,dotvvm.updateProgressChangeCounter(dotvvm.updateProgressChangeCounter()-1),0<n.queue.length){var e=n.queue.shift();window.setTimeout(e,0)}};e instanceof DotvvmAfterPostBackWithRedirectEventArgs&&e.redirectPromise?e.redirectPromise.then(t,t):t()};return e.then(function(e){var t=i.lastStartedPostack==r.postbackId?e:function(){return Promise.reject(null)};return function(){var e=t();return e.then(o,o),e}},function(e){return o(e),Promise.reject(e)})},this.defaultConcurrencyPostbackHandler=this.postbackHandlers["concurrency-default"]({}),this.postbackQueues={},this.postbackHandlersStartedEventHandler={name:"eventInvoke-postbackHandlersStarted",execute:function(e,t){return dotvvm.events.postbackHandlersStarted.trigger(t),e()}},this.postbackHandlersCompletedEventHandler={name:"eventInvoke-postbackHandlersCompleted",after:["eventInvoke-postbackHandlersStarted"],execute:function(e,t){return dotvvm.events.postbackHandlersCompleted.trigger(t),e()}},this.globalPostbackHandlers=[this.suppressOnDisabledElementHandler,this.isPostBackRunningHandler,this.postbackHandlersStartedEventHandler],this.globalLaterPostbackHandlers=[this.postbackHandlersCompletedEventHandler,this.beforePostbackEventPostbackHandler],this.events=new DotvvmEvents,this.globalize=new DotvvmGlobalize,this.evaluator=new DotvvmEvaluator,this.domUtils=new DotvvmDomUtils,this.fileUpload=new DotvvmFileUpload,this.extensions={},this.isPostbackRunning=ko.observable(!1),this.updateProgressChangeCounter=ko.observable(0),this.diffEqual={}}return e.prototype.createWindowSetTimeoutHandler=function(r){return{name:"timeout",before:["eventInvoke-postbackHandlersStarted","setIsPostbackRunning"],execute:function(e,t){return new Promise(function(e,t){return window.setTimeout(e,r)}).then(function(){return e()})}}},e.prototype.getPostbackQueue=function(e){return void 0===e&&(e="default"),this.postbackQueues[e]||(this.postbackQueues[e]={queue:[],noRunning:0}),this.postbackQueues[e]},e.prototype.init=function(t,e){var r=this;this.addKnockoutBindingHandlers();var n=this.viewModels[t]=JSON.parse(document.getElementById("__dot_viewmodel_"+t).value);if(n.resources)for(var o in n.resources)this.resourceSigns[o]=!0;n.renderedResources&&n.renderedResources.forEach(function(e){return r.resourceSigns[e]=!0});var i=n.resultIdFragment;n.viewModelCacheId&&(n.viewModelCache=this.viewModels[t].viewModel);var a=n.viewModel=this.serialization.deserialize(this.viewModels[t].viewModel,{},!0);this.culture=e,this.validation=new DotvvmValidation(this),this.viewModelObservables[t]=ko.observable(a),ko.applyBindings(this.viewModelObservables[t],document.documentElement),this.events.init.trigger({viewModel:a});var s=this.getSpaPlaceHolder();if(null!=s){var l=function(e){return r.handleHashChange(t,s,e)};this.useHistoryApiSpaNavigation=JSON.parse(s.getAttribute("data-dotvvm-spacontentplaceholder-usehistoryapi")),this.useHistoryApiSpaNavigation&&(l=function(e){return r.handleHashChangeWithHistory(t,s,e)});this.domUtils.attachEvent(window,"hashchange",function(){return l(!1)}),l(!0)}if(window.addEventListener("popstate",function(e){return r.handlePopState(t,e,null!=s)}),this.isViewModelUpdating=!1,i)if(s){var u=document.getElementById(i);u&&"function"==typeof u.scrollIntoView&&u.scrollIntoView(!0)}else location.hash=i;this.domUtils.attachEvent(window,"beforeunload",function(e){r.persistViewModel(t)})},e.prototype.handlePopState=function(e,t,r){if(this.spaHistory.isSpaPage(t.state)){var n=this.spaHistory.getHistoryRecord(t.state);r?this.navigateCore(e,n.url):this.performRedirect(n.url,!0),t.preventDefault()}},e.prototype.handleHashChangeWithHistory=function(e,t,r){var n=this;if(0===document.location.hash.indexOf("#!/"))this.navigateCore(e,document.location.hash.substring(2),function(e){n.spaHistory.replacePage(e)});else{var o=t.getAttribute("data-dotvvm-spacontentplaceholder-defaultroute");if(!t.hasAttribute("data-dotvvm-spacontentplaceholder-content")&&o)this.navigateCore(e,"/"+o,function(e){return n.spaHistory.replacePage(e)});else{this.isSpaReady(!0),t.style.display="";var i=location.pathname+location.search+location.hash;this.spaHistory.replacePage(i)}}},e.prototype.handleHashChange=function(e,t,r){if(0===document.location.hash.indexOf("#!/"))this.navigateCore(e,document.location.hash.substring(2));else{var n=t.getAttribute("data-dotvvm-spacontentplaceholder-defaultroute");if(n)n="#!/"+n,n=this.fixSpaUrlPrefix(n),this.performRedirect(n,r);else if(r)this.isSpaReady(!0),t.style.display="";else{var o=(n=document.location.toString()).indexOf("/","https://".length);n=0<o?n.substring(o):"/",this.navigateCore(e,n)}}},e.prototype.persistViewModel=function(e){var t=this.viewModels[e],r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);r.viewModel=this.serialization.serialize(r.viewModel,{serializeAll:!0}),document.getElementById("__dot_viewmodel_"+e).value=JSON.stringify(r)},e.prototype.backUpPostBackConter=function(){return++this.postBackCounter},e.prototype.isPostBackStillActive=function(e){return this.postBackCounter===e},e.prototype.fetchCsrfToken=function(o){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return null!=(t=this.viewModels[o].viewModel).$csrfToken?[3,3]:[4,fetch((this.viewModels[o].virtualDirectory||"")+"/___dotvvm-create-csrf-token___")];case 1:if(200!=(r=e.sent()).status)throw new Error("Can't fetch CSRF token: "+r.statusText);return n=t,[4,r.text()];case 2:n.$csrfToken=e.sent(),e.label=3;case 3:return[2,t.$csrfToken]}})})},e.prototype.staticCommandPostback=function(i,a,s,l,u,d){void 0===u&&(u=function(e){}),void 0===d&&(d=function(e){}),__awaiter(this,void 0,void 0,function(){var t,r,n,o=this;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.fetchCsrfToken(i)];case 1:return t=e.sent(),[3,3];case 2:return r=e.sent(),this.events.error.trigger(new DotvvmErrorEventArgs(a,this.viewModels[i].viewModel,i,null,null)),console.warn("CSRF token fetch failed."),d({error:r}),[2];case 3:return n=this.serialization.serialize({args:l,command:s,$csrfToken:t}),dotvvm.events.staticCommandMethodInvoking.trigger(n),this.postJSON(this.viewModels[i].url,"POST",ko.toJSON(n),function(t){try{o.isViewModelUpdating=!0;var e=JSON.parse(t.responseText);if("action"in e){if("redirect"==e.action)return o.handleRedirect(e,i),void d({xhr:t,error:"redirect"});throw new Error("Invalid action "+e.action)}var r=e.result;dotvvm.events.staticCommandMethodInvoked.trigger(__assign({},n,{result:r,xhr:t})),u(r)}catch(e){dotvvm.events.staticCommandMethodFailed.trigger(__assign({},n,{xhr:t,error:e})),d({xhr:t,error:e})}finally{o.isViewModelUpdating=!1}},function(e){if(/^application\/json(;|$)/.test(e.getResponseHeader("Content-Type"))&&"invalidCsrfToken"===JSON.parse(e.responseText).action)return o.viewModels[i].viewModel.$csrfToken=null,console.log("Resending postback due to invalid CSRF token."),void o.staticCommandPostback(i,a,s,l,u,d);o.events.error.trigger(new DotvvmErrorEventArgs(a,o.viewModels[i].viewModel,i,e,null)),console.warn("StaticCommand postback failed: "+e.status+" - "+e.statusText,e),d({xhr:e}),dotvvm.events.staticCommandMethodFailed.trigger(__assign({},n,{xhr:e}))},function(e){e.setRequestHeader("X-PostbackType","StaticCommand")}),[2]}})})},e.prototype.processPassedId=function(e,t){if("string"==typeof e||null==e)return e;if("object"==typeof e&&e.expr)return this.evaluator.evaluateOnViewModel(t,e.expr);throw new Error("invalid argument")},e.prototype.getPostbackHandler=function(e){var t=this.postbackHandlers[e];if(t)return t;throw new Error("Could not find postback handler of name '"+e+"'")},e.prototype.isPostbackHandler=function(e){return e&&"function"==typeof e.execute},e.prototype.findPostbackHandlers=function(n,e){var o=this,i=function(e,t){return!1===t.enabled?null:o.getPostbackHandler(e)(t)};return e.map(function(e){return"string"==typeof e?i(e,{}):o.isPostbackHandler(e)?e:e instanceof Array?(t=e[0],r=e[1],i(t,"function"==typeof r?r(n,n.$data):r)):i(e.name,e.options&&e.options(n));var t,r}).filter(function(e){return null!=e})},e.prototype.sortHandlers=function(o){for(var r=function(){for(var t={},e=0,r=o;e<r.length;e++){var n=r[e];null!=n.name&&(t[n.name]=n)}return function(e){return"string"==typeof e?t[e]:e}}(),a=o.map(function(e,t){return e["@sort_index"]=t,{handler:e,deps:(e.after||[]).map(r)}}),e=0,t=o;e<t.length;e++){var n=t[e];if(n.before)for(var i=0,s=n.before.map(r);i<s.length;i++){var l=s[i];if(l){var u=l["@sort_index"];a[u].deps.push(n)}}}for(var d=[],v=new Uint8Array(a.length),c=function(e){switch(v[e]){case 0:break;case 1:throw new Error("Cyclic PostbackHandler dependency found.");case 2:return;default:throw new Error("")}if(1!=v[e]){v[e]=1;for(var t=a[e],r=t.handler,n=0,o=t.deps;n<o.length;n++){var i=o[n];c(i["@sort_index"])}v[e]=2,d.push(r)}},p=0;p<a.length;p++)c(p);return d},e.prototype.applyPostbackHandlersCore=function(e,n,t){var r=function(e){return"function"==typeof e?e:function(){return Promise.resolve(new DotvvmAfterPostBackEventArgs(n,null,e))}};return null==t||0===t.length?e(n).then(r,function(e){return Promise.reject(e)}):this.sortHandlers(t).reduceRight(function(e,t,r){return function(){return t.execute(e,n)}},function(){return e(n).then(r,function(e){return Promise.reject(e)})})()},e.prototype.applyPostbackHandlers=function(e,t,r,n,o,i,a){void 0===n&&(n=[]),void 0===o&&(o=ko.contextFor(t)),void 0===i&&(i=o.$root);var s=new PostbackOptions(this.backUpPostBackConter(),t,n,i,a),l=this.applyPostbackHandlersCore(e,s,this.findPostbackHandlers(o,this.globalPostbackHandlers.concat(r||[]).concat(this.globalLaterPostbackHandlers))).then(function(e){return e()},function(e){return Promise.reject(e)});return l.catch(function(e){e&&console.log("Rejected: "+e)}),l},e.prototype.postbackCore=function(h,r,s,l,u,d){var e=this;return new Promise(function(a,t){return __awaiter(e,void 0,void 0,function(){var c,p,n,o,i,f=this;return __generator(this,function(e){switch(e.label){case 0:c=h.viewModelName,p=this.viewModels[c].viewModel,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.fetchCsrfToken(c)];case 2:return e.sent(),[3,4];case 3:return e.sent(),t({type:"network",options:h,args:new DotvvmErrorEventArgs(h.sender,p,c,null,h.postbackId)}),[2];case 4:return this.lastStartedPostack=h.postbackId,this.updateDynamicPathFragments(u,r),n={currentPath:r,command:s,controlUniqueId:this.processPassedId(l,u),additionalData:h.additionalPostbackData,renderedResources:this.viewModels[c].renderedResources,commandArgs:d},o=this.serialization.serialize(p,{pathMatcher:function(e){return u&&e==u.$data}}),this.viewModels[c].viewModelCache?(n.viewModelDiff=this.diff(this.viewModels[c].viewModelCache,o),n.viewModelCacheId=this.viewModels[c].viewModelCacheId):n.viewModel=o,i=function(e){if(/^application\/json(;|$)/.test(e.getResponseHeader("Content-Type"))&&"invalidCsrfToken"===JSON.parse(e.responseText).action)return f.viewModels[c].viewModel.$csrfToken=null,console.log("Resending postback due to invalid CSRF token."),void f.postbackCore(h,r,s,l,u,d).then(a,t);t({type:"network",options:h,args:new DotvvmErrorEventArgs(h.sender,p,c,e,h.postbackId)})},this.postJSON(this.viewModels[c].url,"POST",ko.toJSON(n),function(d){var v={},t=function(u){dotvvm.events.postbackResponseReceived.trigger({}),a(function(){return new Promise(function(s,l){dotvvm.events.postbackCommitInvoked.trigger({}),!v.viewModel&&v.viewModelDiff&&(v.viewModel=f.patch(o,v.viewModelDiff)),f.loadResourceList(v.resources,function(){var e=!1;if("successfulCommand"===v.action){try{f.isViewModelUpdating=!0,v.viewModelCacheId?(f.viewModels[c].viewModelCacheId=v.viewModelCacheId,f.viewModels[c].viewModelCache=v.viewModel):(delete f.viewModels[c].viewModelCacheId,delete f.viewModels[c].viewModelCache);var t=f.cleanUpdatedControls(v);v.viewModel&&(ko.delaySync.pause(),f.serialization.deserialize(v.viewModel,f.viewModels[c].viewModel),ko.delaySync.resume()),e=!0,f.cleanUpdatedControls(v,t),f.restoreUpdatedControls(v,t,!0)}finally{f.isViewModelUpdating=!1}dotvvm.events.postbackViewModelUpdated.trigger({})}else if("redirect"===v.action){var r=f.handleRedirect(v,c),n=new DotvvmAfterPostBackWithRedirectEventArgs(h,v,v.commandResult,d,r);return void s(n)}var o=v.resultIdFragment;if(o)if(f.getSpaPlaceHolder()||location.hash=="#"+o){var i=document.getElementById(o);i&&"function"==typeof i.scrollIntoView&&i.scrollIntoView(!0)}else location.hash=o;if(e){var a=new DotvvmAfterPostBackEventArgs(h,v,v.commandResult,d);s(a)}else l(new DotvvmErrorEventArgs(h.sender,p,c,u,h.postbackId,v))})})})},r=function(e){var t=e.getResponseHeader("Location");v=null!=t&&0<t.length?{action:"redirect",url:t}:JSON.parse(e.responseText)};if(r(d),"viewModelNotCached"===v.action)return delete f.viewModels[c].viewModelCache,delete f.viewModels[c].viewModelCacheId,delete n.viewModelDiff,delete n.viewModelCacheId,n.viewModel=o,f.postJSON(f.viewModels[c].url,"POST",ko.toJSON(n),function(e){r(e),t(e)},i);t(d)},i),[2]}})})})},e.prototype.handleSpaNavigation=function(e){return"_blank"==e.getAttribute("target")?Promise.resolve(new DotvvmNavigationEventArgs(this.viewModels.root.viewModel,"root",null)):this.handleSpaNavigationCore(e.getAttribute("href"))},e.prototype.handleSpaNavigationCore=function(r){var n=this;return new Promise(function(e,t){if(r&&0===r.indexOf("/")){r=n.removeVirtualDirectoryFromUrl(r,"root"),n.navigateCore("root",r,function(e){history.state&&history.state.url==e||n.spaHistory.pushPage(e)}).then(e,t)}else t()})},e.prototype.postBack=function(e,t,r,n,o,i,a,s){var l=this;i=i||ko.contextFor(t);var u=this.findPostbackHandlers(i,this.globalPostbackHandlers.concat(a||[]).concat(this.globalLaterPostbackHandlers));0==u.filter(function(e){return e.name&&0==e.name.indexOf("concurrency-")}).length&&u.push(this.defaultConcurrencyPostbackHandler);var d=new PostbackOptions(this.backUpPostBackConter(),t,s,i.$data,e),v=this.applyPostbackHandlersCore(function(e){return l.postbackCore(e,r,n,o,i,s)},d,u).then(function(e){return e().then(function(e){return e},function(e){return Promise.reject({type:"commit",args:e})})},function(e){return Promise.reject(e)});return v.then(function(e){return e&&l.events.afterPostback.trigger(e)},function(e){var t=new DotvvmAfterPostBackEventArgs(d,"commit"==e.type&&e.args?e.args.serverResponseObject:null,d.postbackId);"handler"==e.type||"event"==e.type?(t.wasInterrupted=!0,l.events.postbackRejected.trigger({})):"network"==e.type&&l.events.error.trigger(e.args),l.events.afterPostback.trigger(t)}),v},e.prototype.loadResourceList=function(e,t){var r="";for(var n in e){if(!/^__noname_\d+$/.test(n)){if(this.resourceSigns[n])continue;this.resourceSigns[n]=!0}r+=e[n]+" "}if(""!==r.trim()){var o=document.createElement("div");o.innerHTML=r;for(var i=[],a=0;a<o.children.length;a++)i.push(o.children.item(a));this.loadResourceElements(i,0,t)}else setTimeout(t,4)},e.prototype.loadResourceElements=function(e,t,r){var n=this;if(t>=e.length)r();else{var o=e[t],i=!1;if("script"==o.tagName.toLowerCase()){var a=o,s=document.createElement("script");a.src&&(s.src=a.src,i=!0),a.type&&(s.type=a.type),a.text&&(s.text=a.text),o.id&&(s.id=o.id),o=s}else if("link"==o.tagName.toLowerCase()){var l=o,u=document.createElement("link");l.href&&(u.href=l.href),l.rel&&(u.rel=l.rel),l.type&&(u.type=l.type),o=u}i&&(o.addEventListener("load",function(){return n.loadResourceElements(e,t+1,r)}),o.addEventListener("error",function(){return n.loadResourceElements(e,t+1,r)})),document.head.appendChild(o),i||this.loadResourceElements(e,t+1,r)}},e.prototype.getSpaPlaceHolder=function(){var e=document.getElementsByName("__dot_SpaContentPlaceHolder");return 1==e.length?e[0]:null},e.prototype.navigateCore=function(d,v,c){var p=this;return new Promise(function(a,s){var r=p.viewModels[d].viewModel,n=p.backUpPostBackConter(),e=new DotvvmSpaNavigatingEventArgs(r,d,v);if(p.events.spaNavigating.trigger(e),!e.cancel){var t=p.viewModels[d].virtualDirectory||"",o="/___dotvvm-spa___"+p.addLeadingSlash(v),i=p.addLeadingSlash(p.concatUrl(t,o)),l=p.getSpaPlaceHolder();if(l){c&&c(p.addLeadingSlash(p.concatUrl(t,p.addLeadingSlash(v))));var u=l.attributes["data-dotvvm-spacontentplaceholder"].value;p.getJSON(i,"GET",u,function(o){if(p.isPostBackStillActive(n)){var i=JSON.parse(o.responseText);p.loadResourceList(i.resources,function(){var e=!1;if("successfulCommand"!==i.action&&i.action){if("redirect"===i.action)return void p.handleRedirect(i,d,!0).then(a,s)}else try{p.isViewModelUpdating=!0;var t=p.cleanUpdatedControls(i);for(var r in p.viewModels[d]={},i)i.hasOwnProperty(r)&&(p.viewModels[d][r]=i[r]);i.viewModelCacheId?p.viewModels[d].viewModelCache=i.viewModel:delete p.viewModels[d].viewModelCache,ko.delaySync.pause(),p.serialization.deserialize(i.viewModel,p.viewModels[d].viewModel),ko.delaySync.resume(),e=!0,p.viewModelObservables[d](p.viewModels[d].viewModel),p.restoreUpdatedControls(i,t,!0),p.isSpaReady(!0)}finally{p.isViewModelUpdating=!1}var n=new DotvvmSpaNavigatedEventArgs(p.viewModels[d].viewModel,d,i,o);if(p.events.spaNavigated.trigger(n),a(n),!e&&!n.isHandled)throw s(),"Invalid response from server!"})}},function(e){if(p.isPostBackStillActive(n)){var t=new DotvvmErrorEventArgs(void 0,r,d,e,-1,void 0,!0);p.events.error.trigger(t),t.handled||alert(e.responseText),s(t)}})}else document.location.href=i}})},e.prototype.handleRedirect=function(e,t,r){var n;void 0===r&&(r=!1),null!=e.replace&&(r=e.replace),n=this.getSpaPlaceHolder()&&!this.useHistoryApiSpaNavigation&&e.url.indexOf("//")<0&&e.allowSpa?("#!"===(n="#!"+this.removeVirtualDirectoryFromUrl(e.url,t))&&(n="#!/"),this.fixSpaUrlPrefix(n)):e.url;var o=new DotvvmRedirectEventArgs(dotvvm.viewModels[t],t,n,r);return this.events.redirect.trigger(o),this.performRedirect(n,r,e.allowSpa&&this.useHistoryApiSpaNavigation)},e.prototype.performRedirect=function(n,o,i){var a=this;return new Promise(function(e,t){if(o)location.replace(n),e();else if(i)a.handleSpaNavigationCore(n).then(e,t);else{var r=a.fakeRedirectAnchor;r||((r=document.createElement("a")).style.display="none",r.setAttribute("data-dotvvm-fake-id","dotvvm_fake_redirect_anchor_87D7145D_8EA8_47BA_9941_82B75EE88CDB"),document.body.appendChild(r),a.fakeRedirectAnchor=r),r.href=n,r.click(),e()}})},e.prototype.fixSpaUrlPrefix=function(e){var t=this.getSpaPlaceHolder().attributes["data-dotvvm-spacontentplaceholder-urlprefix"];if(!t)return e;var r=t.value;return r!==document.location.pathname&&(""===r&&(r="/"),e=r+e),e},e.prototype.removeVirtualDirectoryFromUrl=function(e,t){var r="/"+this.viewModels[t].virtualDirectory;return 0==e.indexOf(r)?this.addLeadingSlash(e.substring(r.length)):e},e.prototype.addLeadingSlash=function(e){return 0<e.length&&"/"!=e.substring(0,1)?"/"+e:e},e.prototype.concatUrl=function(e,t){return 0<e.length&&"/"==e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e+this.addLeadingSlash(t)},e.prototype.patch=function(r,e){var n=this;if(r instanceof Array&&e instanceof Array)return e.map(function(e,t){return n.patch(r[t],e)});if(r instanceof Array||e instanceof Array)return e;if("object"!=typeof r||"object"!=typeof e||!r||!e)return e;for(var t in e)null==e[t]?r[t]=null:null==r[t]?r[t]=e[t]:r[t]=this.patch(r[t],e[t]);return r},e.prototype.diff=function(r,n){var o=this;if(r instanceof Array&&n instanceof Array){var e=n.map(function(e,t){return o.diff(r[t],e)});return r.length===n.length&&e.every(function(e,t){return e===o.diffEqual||r[t]===n[t]})?this.diffEqual:e}if(r instanceof Array||n instanceof Array)return n;if("object"==typeof r&&"object"==typeof n&&r&&n){var t=this.diffEqual;for(var i in n){var a=this.diff(r[i],n[i]);a!==this.diffEqual&&r[i]!==n[i]?(t===this.diffEqual&&(t={}),t[i]=a):"$"===i[0]&&(t==this.diffEqual&&(t={}),t[i]=n[i])}return t}return r===n?"object"==typeof r?this.diffEqual:r:n},e.prototype.updateDynamicPathFragments=function(e,t){for(var r=t.length-1;0<=r;r--)0<=t[r].indexOf("[$index]")&&(t[r]=t[r].replace("[$index]","["+e.$index()+"]")),0<=t[r].indexOf("[$indexPath]")&&(t[r]=t[r].replace("[$indexPath]","["+e.$indexPath.map(function(e){return e()}).join("]/[")+"]")),e=e.$parentContext},e.prototype.postJSON=function(e,t,r,n,o,i){void 0===i&&(i=function(e){});var a=this.getXHR();a.open(t,e,!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-DotVVM-PostBack","true"),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),i(a),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&(a.status&&a.status<400?n(a):o(a))},a.send(r)},e.prototype.getJSON=function(e,t,r,n,o){var i=this.getXHR();i.open(t,e,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("X-DotVVM-SpaContentPlaceHolder",r),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&(i.status&&i.status<400?n(i):o(i))},i.send()},e.prototype.getXHR=function(){return XMLHttpRequest?new XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP")},e.prototype.cleanUpdatedControls=function(e,t){for(var r in void 0===t&&(t={}),e.updatedControls)if(e.updatedControls.hasOwnProperty(r)){var n=document.getElementByDotvvmId(r);if(n){var o=ko.contextFor(n),i=n.nextSibling,a=n.parentNode;ko.removeNode(n),t[r]={control:n,nextSibling:i,parent:a,dataContext:o}}}return t},e.prototype.restoreUpdatedControls=function(r,n,e){var o=this;for(var t in r.updatedControls)if(r.updatedControls.hasOwnProperty(t)){var i=n[t];if(i){var a=document.createElement(n[t].parent.tagName||"div");if(a.innerHTML=r.updatedControls[t],1<a.childElementCount)throw new Error("Postback.Update control can not render more than one element");var s=a.firstElementChild;if(null==s.id)throw new Error("Postback.Update control always has to render id attribute.");s.id!==n[t].control.id&&console.log("Postback.Update control changed id from '"+n[t].control.id+"' to '"+s.id+"'"),a.removeChild(s),i.nextSibling?i.parent.insertBefore(s,i.nextSibling):i.parent.appendChild(s)}}e&&window.setTimeout(function(){try{for(var e in o.isViewModelUpdating=!0,r.updatedControls){var t=document.getElementByDotvvmId(e);t&&ko.applyBindings(n[e].dataContext,t)}}finally{o.isViewModelUpdating=!1}},0)},e.prototype.unwrapArrayExtension=function(e){return ko.unwrap(ko.unwrap(e))},e.prototype.buildRouteUrl=function(e,a){var t=(e="/"+e).replace(/(\/[^\/]*?)\{([^\}]+?)\??(:(.+?))?\}/g,function(e,t,r,n,o){if(!r)return"";var i=ko.unwrap(a[r.toLowerCase()]);return null==i?"":t+i});return 0===t.indexOf("/")?t.substring(1):t},e.prototype.buildUrlSuffix=function(e,t){var r,n;for(var o in n=-1!==e.indexOf("#")?(r=e.substring(0,e.indexOf("#")),e.substring(e.indexOf("#"))):(r=e,""),t)if(t.hasOwnProperty(o)){if(!o)continue;var i=ko.unwrap(t[o]);if(null==i)continue;r=r.concat(-1!==r.indexOf("?")?"&"+o+"="+i:"?"+o+"="+i)}return r.concat(n)},e.prototype.isPostBackProhibited=function(e){return!!(e&&e.tagName&&-1<["a","input","button"].indexOf(e.tagName.toLowerCase())&&e.getAttribute("disabled"))},e.prototype.addKnockoutBindingHandlers=function(){function v(r,n){void 0===n&&(n=null);var e=ko.pureComputed({read:function(){var e=r();return ko.unwrap(e)},write:function(e){var t=r();ko.isObservable(t)?t(e):console.warn("Attempted to write to readonly property"+(null==n?"":" "+n)+".")}});return e.wrappedProperty=r,e}ko.virtualElements.allowedBindings.dotvvm_withControlProperties=!0,ko.bindingHandlers.dotvvm_withControlProperties={init:function(e,t,r,n,o){if(!o)throw new Error;var i=t();for(var a in i)i[a]=v(function(){var e=t()[this.prop];return ko.isObservable(e)?e:dotvvm.serialization.deserialize(e)}.bind({prop:a}),"'"+a+"' at '"+t.toString()+"'");var s=o.extend({$control:i});return e.innerBindingContext=s,ko.applyBindingsToDescendants(s,e),{controlsDescendantBindings:!0}},update:function(e,t,r,n,o){}},ko.virtualElements.allowedBindings.dotvvm_introduceAlias=!0,ko.bindingHandlers.dotvvm_introduceAlias={init:function(e,t,r,n,o){if(!o)throw new Error;var i=t(),a={};for(var s in i){for(var l=s.split("."),u=a;0<l.length-1;0)u=a[l[0]]||(a[l[0]]={});u[l[l.length-1]]=v(function(){return t()[this.prop]}.bind({prop:s}),"'"+s+"' at '"+t.toString()+"'")}var d=o.extend(a);return e.innerBindingContext=d,ko.applyBindingsToDescendants(d,e),{controlsDescendantBindings:!0}}};var e=function(a,s){return function(t,r,e,n,o){if(!o)throw new Error;var i;return ko.computed(function(){var e=r();!i&&ko.computedContext.getDependenciesCount()&&(i=ko.utils.cloneNodes(ko.virtualElements.childNodes(t),!0)),s(e)?(i&&ko.virtualElements.setDomNodeChildren(t,ko.utils.cloneNodes(i)),ko.applyBindingsToDescendants(a(o,e),t)):ko.virtualElements.emptyNode(t)},null,{disposeWhenNodeIsRemoved:t}),{controlsDescendantBindings:!0}}},s="$foreachCollectionSymbol";ko.virtualElements.allowedBindings["dotvvm-SSR-foreach"]=!0,ko.bindingHandlers["dotvvm-SSR-foreach"]={init:e(function(e,t){var r;return e.extend(((r={})[s]=t.data,r))},function(e){return null!=e.data})},ko.virtualElements.allowedBindings["dotvvm-SSR-item"]=!0,ko.bindingHandlers["dotvvm-SSR-item"]={init:function(e,t,r,n,o){if(!o)throw new Error;var i=o[s],a=o.createChildContext(function(){return ko.unwrap((ko.unwrap(i)||[])[t()])}).extend({$index:ko.pureComputed(t)});return e.innerBindingContext=a,ko.applyBindingsToDescendants(a,e),{controlsDescendantBindings:!0}},update:function(e){e.seenUpdate&&console.error("dotvvm-SSR-item binding did not expect to see a update"),e.seenUpdate=1}},ko.virtualElements.allowedBindings.withGridViewDataSet=!0,ko.bindingHandlers.withGridViewDataSet={init:e(function(e,t){var r;return e.extend(((r={$gridViewDataSet:t})[s]=dotvvm.evaluator.getDataSourceItems(t),r))},function(e){return!0})},ko.bindingHandlers.dotvvmEnable={update:function(e,t){var r=ko.utils.unwrapObservable(t());r&&e.disabled?(e.disabled=!1,e.removeAttribute("disabled")):r||e.disabled||(e.disabled=!0,e.setAttribute("disabled","disabled"))}},ko.bindingHandlers["dotvvm-checkbox-updateAfterPostback"]={init:function(e,t,n,r,o){dotvvm.events.afterPostback.subscribe(function(e){var t=n();if(t["dotvvm-checked-pointer"]){var r=t[t["dotvvm-checked-pointer"]];ko.isObservable(r)&&(r.valueHasMutated?r.valueHasMutated():r.notifySubscribers())}})}},ko.bindingHandlers["dotvvm-checked-pointer"]={init:function(e,t,r,n,o){}},ko.bindingHandlers["dotvvm-checkedItems"]={after:ko.bindingHandlers.checked.after,init:ko.bindingHandlers.checked.init,options:ko.bindingHandlers.checked.options,update:function(e,t,r,n,o){var i=t();if(!Array.isArray(ko.unwrap(i)))throw Error("The value of a `checkedItems` binding must be an array (i.e. not null nor undefined).")}},ko.bindingHandlers["dotvvm-UpdateProgress-Visible"]={init:function(n,e,t,r,o){n.style.display="none";var i,a=n.getAttribute("data-delay"),s=(n.getAttribute("data-included-queues")||"").split(",").filter(function(e){return 0<e.length}),l=(n.getAttribute("data-excluded-queues")||"").split(",").filter(function(e){return 0<e.length}),u=!1;dotvvm.updateProgressChangeCounter.subscribe(function(e){var t=!1;if(0===s.length){for(var r in dotvvm.postbackQueues)if(l.indexOf(r)<0&&0<dotvvm.postbackQueues[r].noRunning){t=!0;break}}else t=s.some(function(e){return dotvvm.postbackQueues[e]&&0<dotvvm.postbackQueues[e].noRunning});t?u||(u=!0,null==a?n.style.display="":i=setTimeout(function(e){n.style.display=""},a)):(u=!1,clearTimeout(i),n.style.display="none")})}},ko.bindingHandlers["dotvvm-table-columnvisible"]={init:function(e,t,r,n,o){var i="",a=!0;if(e instanceof HTMLTableCellElement){for(var s=e;!(s instanceof HTMLTableElement);)s=s.parentElement;var l=s.rows.item(0);if(!l)throw Error("Table with dotvvm-table-columnvisible binding handler must not be empty.");var u=[].slice.call(l.cells).indexOf(e);e.dotvvmChangeVisibility=function(e,t,r){if(a!=r){a=r;for(var n=0;n<e.rows.length;n++){var o=e.rows.item(n).cells[t].style;r?o.display=i:(i=o.display||"",o.display="none")}}}.bind(null,s,u)}},update:function(e,t){e.dotvvmChangeVisibility(ko.unwrap(t()))}},ko.bindingHandlers["dotvvm-textbox-text"]={init:function(n,e,t,r,o){var i=e(),a=(t.get("valueUpdate"),new DotvvmValidationElementMetadata);a.element=n,a.dataType=(n.attributes["data-dotvvm-value-type"]||{value:""}).value,a.format=(n.attributes["data-dotvvm-format"]||{value:""}).value;var s=null;s=ko.isObservable(i)?(i.dotvvmMetadata?(i.dotvvmMetadata.elementsMetadata||(i.dotvvmMetadata.elementsMetadata=[]),i.dotvvmMetadata.elementsMetadata.push(a)):(i.dotvvmMetadata=new DotvvmValidationObservableMetadata,i.dotvvmMetadata.elementsMetadata=[a]),i.dotvvmMetadata.elementsMetadata):new DotvvmValidationObservableMetadata,setTimeout(function(n,o){ko.utils.domNodeDisposal.addDisposeCallback(o,function(){for(var e=0,t=n;e<t.length;e++){var r=t[e];if(r.element===o){n.splice(n.indexOf(r),1);break}}})},0,s,n),dotvvm.domUtils.attachEvent(n,"change",function(){if(ko.isObservable(i)){var e,t;if("datetime"===a.dataType){var r=i();null!=r&&(r=dotvvm.globalize.parseDotvvmDate(r)),t=null==(e=dotvvm.globalize.parseDate(n.value,a.format,r))?null:dotvvm.serialization.serializeDate(e,!1)}else t=null===(e=dotvvm.globalize.parseNumber(n.value))||isNaN(e)?null:e;null==t&&null!==n.value&&""!==n.value?(n.attributes["data-invalid-value"]=n.value,n.attributes["data-dotvvm-value-type-valid"]=!1,a.elementValidationState=!1):(n.attributes["data-invalid-value"]=null,n.attributes["data-dotvvm-value-type-valid"]=!0,a.elementValidationState=!0),i()===t?i.valueHasMutated?i.valueHasMutated():i.notifySubscribers():i(t)}})},update:function(e,t,r,n,o){var i=t(),a=(e.attributes["data-dotvvm-format"]||{value:""}).value,s=ko.unwrap(i);if(a){var l=dotvvm.globalize.formatString(a,s),u=e.attributes["data-invalid-value"];if(null==u){if(e.value=l||"",i.dotvvmMetadata&&i.dotvvmMetadata.elementsMetadata)for(var d=0,v=i.dotvvmMetadata.elementsMetadata;d<v.length;d++){var c=v[d];c.element===e&&(e.attributes["data-dotvvm-value-type-valid"]=!0,c.elementValidationState=!0)}}else e.attributes["data-invalid-value"]=null,e.value=u}else e.value=s}},ko.bindingHandlers["dotvvm-textbox-select-all-on-focus"]={init:function(e,t,r,n,o){e.$selectAllOnFocusHandler=function(){e.select()}},update:function(e,t,r,n,o){!0===ko.unwrap(t())?e.addEventListener("focus",e.$selectAllOnFocusHandler):e.removeEventListener("focus",e.$selectAllOnFocusHandler)}},ko.bindingHandlers["dotvvm-CheckState"]={init:function(e,t,r,n,o){ko.getBindingHandler("checked").init(e,t,r,n,o)},update:function(e,t,r){var n=ko.unwrap(t());e.indeterminate=null==n}}},e}(),DotvvmValidationContext=function(e,t,r){this.valueToValidate=e,this.parentViewModel=t,this.parameters=r},DotvvmValidationObservableMetadata=function(){},DotvvmValidationElementMetadata=function(){this.elementValidationState=!0},DotvvmValidatorBase=function(){function e(){}return e.prototype.isValid=function(e,t){return!1},e.prototype.isEmpty=function(e){return null==e||"string"==typeof e&&""===e.trim()},e.prototype.getValidationMetadata=function(e){return e.dotvvmMetadata},e}(),DotvvmRequiredValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate;return!this.isEmpty(t)},t}(DotvvmValidatorBase),DotvvmRegularExpressionValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate,r=e.parameters[0];return this.isEmpty(t)||new RegExp(r).test(t)},t}(DotvvmValidatorBase),DotvvmIntRangeValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate,r=e.parameters[0],n=e.parameters[1];return t%1==0&&r<=t&&t<=n},t}(DotvvmValidatorBase),DotvvmEnforceClientFormatValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e,t){var r=!0;e.parameters[0]||null!=e.valueToValidate||(r=!1),e.parameters[1]||0!==e.valueToValidate.length||(r=!1),!e.parameters[2]&&this.isEmpty(e.valueToValidate)&&(r=!1);var n=this.getValidationMetadata(t);if(n&&n.elementsMetadata)for(var o=0,i=n.elementsMetadata;o<i.length;o++){i[o].elementValidationState||(r=!1)}return r},t}(DotvvmValidatorBase),DotvvmRangeValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e,t){var r=e.valueToValidate,n=e.parameters[0],o=e.parameters[1];return n<=r&&r<=o},t}(DotvvmValidatorBase),DotvvmNotNullValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){return null!==e.valueToValidate&&void 0!==e.valueToValidate},t}(DotvvmValidatorBase),DotvvmEmailAddressValidator=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.isValid=function(e){var t=e.valueToValidate;if(null==t)return!0;if("string"!=typeof t)return!1;for(var r=!1,n=0;n<t.length;n++)if("@"==t[n]){if(r||0==n||n==t.length-1)return!1;r=!0}return r},t}(DotvvmValidatorBase),ErrorsPropertyName="validationErrors",ValidationError=function(){function n(e,t){this.errorMessage=e,this.validatedObservable=t}return n.attach=function(e,t){if(!e)throw new Error('String "'+e+'" is not a valid ValidationError message.');if(!t)throw new Error('ValidationError cannot be attached to "'+t+'".');"wrappedProperty"in t&&(t=t.wrappedProperty()),t.hasOwnProperty(ErrorsPropertyName)||(t[ErrorsPropertyName]=[]);var r=new n(e,t);return t[ErrorsPropertyName].push(r),dotvvm.validation.errors.push(r),r},n.prototype.detach=function(){var e=this.validatedObservable.validationErrors.indexOf(this);this.validatedObservable.validationErrors.splice(e,1);var t=dotvvm.validation.errors.indexOf(this);dotvvm.validation.errors.splice(t,1)},n}(),DotvvmValidation=function(){function u(s){var i=this;this.rules={required:new DotvvmRequiredValidator,regularExpression:new DotvvmRegularExpressionValidator,intrange:new DotvvmIntRangeValidator,range:new DotvvmRangeValidator,emailAddress:new DotvvmEmailAddressValidator,notnull:new DotvvmNotNullValidator,enforceClientFormat:new DotvvmEnforceClientFormatValidator},this.errors=[],this.events={validationErrorsChanged:new DotvvmEvent("dotvvm.validation.events.validationErrorsChanged")},this.elementUpdateFunctions={hideWhenValid:function(e,t,r){0<t.length?e.style.display="":e.style.display="none"},invalidCssClass:function(e,t,r){for(var n=r.split(/\s+/).filter(function(e){return 0<e.length}),o=0;o<n.length;o++){var i=n[o];0<t.length?e.classList.add(i):e.classList.remove(i)}},setToolTipText:function(e,t,r){0<t.length?e.title=t.join(" "):e.title=""},showErrorMessageText:function(e,t,r){e[e.innerText?"innerText":"textContent"]=t.join(" ")}};var t=function(o){return{execute:function(e,t){if(o){t.additionalPostbackData.validationTargetPath=o;var r=ko.contextFor(t.sender),n=s.evaluator.evaluateOnViewModel(r,o);if(i.detachAllErrors(),i.validateViewModel(n),i.events.validationErrorsChanged.trigger({viewModel:t.viewModel}),0<i.errors.length)return console.log("Validation failed: postback aborted; errors: ",i.errors),Promise.reject({type:"handler",handler:i,message:"Validation failed"})}return e()}}};s.postbackHandlers.validate=function(e){return t(e.path)},s.postbackHandlers["validate-root"]=function(){return t("dotvvm.viewModelObservables['root']")},s.postbackHandlers["validate-this"]=function(){return t("$data")},s.events.afterPostback.subscribe(function(e){!e.wasInterrupted&&e.serverResponseObject&&("successfulCommand"===e.serverResponseObject.action?(i.mergeValidationRules(e),e.isHandled=!0):"validationErrors"===e.serverResponseObject.action&&(i.detachAllErrors(),i.showValidationErrorsFromServer(e),i.events.validationErrorsChanged.trigger(e),e.isHandled=!0))}),s.events.spaNavigating.subscribe(function(e){i.detachAllErrors(),i.events.validationErrorsChanged.trigger({viewModel:e.viewModel})}),ko.bindingHandlers.dotvvmValidation={init:function(t,r,n){s.validation.events.validationErrorsChanged.subscribe(function(e){i.applyValidatorOptions(t,r(),n.get("dotvvmValidationOptions"))})},update:function(e,t,r){i.applyValidatorOptions(e,t(),r.get("dotvvmValidationOptions"))}},ko.bindingHandlers["dotvvm-validationSummary"]={init:function(i,e){var a=e();s.validation.events.validationErrorsChanged.subscribe(function(e){i.innerHTML="";for(var t=0,r=s.validation.getValidationErrors(a.target,a.includeErrorsFromChildren,a.includeErrorsFromTarget);t<r.length;t++){var n=r[t],o=document.createElement("li");o.innerText=n.errorMessage,i.appendChild(o)}})}}}return u.prototype.validateViewModel=function(e){if(ko.isObservable(e)&&(e=ko.unwrap(e)),e){var t=(dotvvm.viewModels.root.validationRules||{})[ko.unwrap(e.$type)]||{};for(var r in e)if(e.hasOwnProperty(r)&&0!==r.indexOf("$")){var n=e[r];if(n&&ko.isObservable(n)){var o=n();t.hasOwnProperty(r)&&this.validateProperty(e,n,o,t[r]);var i=e[r+"$options"];if(i&&i.type&&!u.hasErrors(n)&&!dotvvm.serialization.validateType(o,i.type)&&ValidationError.attach("The value of property "+r+" ("+o+") is invalid value for type "+i.type+".",n),o)if(Array.isArray(o))for(var a=0,s=o;a<s.length;a++){var l=s[a];this.validateViewModel(l)}else o&&o instanceof Object&&this.validateViewModel(o)}}}},u.prototype.validateProperty=function(e,t,r,n){for(var o=0,i=n;o<i.length;o++){var a=i[o],s=this.rules[a.ruleName],l=new DotvvmValidationContext(r,e,a.parameters);s.isValid(l,t)||ValidationError.attach(a.errorMessage,t)}},u.prototype.mergeValidationRules=function(e){if(e.serverResponseObject.validationRules){var t=dotvvm.viewModels[e.viewModelName].validationRules;for(var r in void 0===t&&(dotvvm.viewModels[e.viewModelName].validationRules={},t=dotvvm.viewModels[e.viewModelName].validationRules),e.serverResponseObject.validationRules)e.serverResponseObject.validationRules.hasOwnProperty(r)&&(t[r]=e.serverResponseObject.validationRules[r])}},u.prototype.clearValidationErrors=function(e){if(e&&ko.isObservable(e)){if(e[ErrorsPropertyName])for(var t=0,r=e[ErrorsPropertyName].concat([]);t<r.length;t++){r[t].detach()}var n=ko.unwrap(e);if(n){if(Array.isArray(n))for(var o=0,i=n;o<i.length;o++){var a=i[o];this.clearValidationErrors(a)}for(var s in n)if(n.hasOwnProperty(s)&&0!==s.indexOf("$")){var l=n[s];this.clearValidationErrors(l)}}}},u.prototype.detachAllErrors=function(){for(;0<this.errors.length;)this.errors[0].detach()},u.prototype.getValidationErrors=function(e,t,r,n){if(void 0===n&&(n=!0),!e)return[];var o=[];if(r&&e.hasOwnProperty(ErrorsPropertyName)&&(o=o.concat(e[ErrorsPropertyName])),!n)return o;var i=ko.unwrap(e);if(Array.isArray(i)){for(var a=0,s=i;a<s.length;a++){var l=s[a];o=o.concat(this.getValidationErrors(l,t,!0,t))}return o}for(var u in i)if(i.hasOwnProperty(u)&&0!==u.indexOf("$")){var d=i[u];d&&ko.isObservable(d)&&(o=o.concat(this.getValidationErrors(d,t,!0,t)))}return o},u.prototype.showValidationErrorsFromServer=function(e){var t=ko.contextFor(e.sender),r=dotvvm.evaluator.evaluateOnViewModel(t,e.postbackOptions.additionalPostbackData.validationTargetPath);if(r)for(var n=e.serverResponseObject.modelState,o=0;o<n.length;o++){var i,a=n[o].propertyPath;i=a?(ko.isObservable(r)&&(r=ko.unwrap(r)),dotvvm.evaluator.evaluateOnViewModel(r,a)):r,ValidationError.attach(n[o].errorMessage,i)}},u.hasErrors=function(e){return"wrappedProperty"in e&&(e=e.wrappedProperty()),e.hasOwnProperty(ErrorsPropertyName)&&0<e[ErrorsPropertyName].length},u.prototype.applyValidatorOptions=function(e,t,r){if(ko.isObservable(t)){"wrappedProperty"in t&&(t=t.wrappedProperty());var n=(t[ErrorsPropertyName]||[]).map(function(e){return e.errorMessage});for(var o in r)r.hasOwnProperty(o)&&dotvvm.validation.elementUpdateFunctions[o](e,n,r[o])}},u}(),DotvvmEvaluator=function(){function DotvvmEvaluator(){}return DotvvmEvaluator.prototype.evaluateOnViewModel=function(context,expression){var result;return result=context&&context.$data?eval("(function ($context) { with($context) { with ($data) { return "+expression+"; } } })")(context):eval("(function ($context) { var $data=$context; with($context) { return "+expression+"; } })")(context),result&&result.$data&&(result=result.$data),result},DotvvmEvaluator.prototype.evaluateOnContext=function(e,t){var r=!1;for(var n in e)if(0===t.indexOf(n)){r=!0;break}return r||(t="$data."+t),this.evaluateOnViewModel(e,t)},DotvvmEvaluator.prototype.getDataSourceItems=function(e){var t=ko.unwrap(e);return void 0===t||null==t?[]:ko.unwrap(t.Items||t)},DotvvmEvaluator.prototype.tryEval=function(e){try{return e()}catch(e){return null}},DotvvmEvaluator.prototype.isObservableArray=function(e){return ko.isComputed(e)?Array.isArray(e.peek()):!!ko.isObservable(e)&&"push"in e},DotvvmEvaluator.prototype.wrapObservable=function(r,e){var n=this,t=ko.pureComputed({read:function(){return ko.unwrap(n.getExpressionResult(r))},write:function(e){return n.updateObservable(r,e)}});return e&&(t.push=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"push",e)},t.pop=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"pop",e)},t.unshift=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"unshift",e)},t.shift=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"shift",e)},t.reverse=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"reverse",e)},t.sort=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"sort",e)},t.splice=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"splice",e)},t.slice=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"slice",e)},t.replace=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"replace",e)},t.indexOf=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"indexOf",e)},t.remove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"remove",e)},t.removeAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.updateObservableArray(r,"removeAll",e)},t=t.extend({trackArrayChanges:!0})),t.extend({notify:"always"})},DotvvmEvaluator.prototype.updateObservable=function(e,t){var r=this.getExpressionResult(e);ko.isWriteableObservable(r)?r(t):console.error("Cannot write a value to ko.computed because the expression '"+e+"' does not return a writable observable.")},DotvvmEvaluator.prototype.updateObservableArray=function(e,t,r){var n=this.getExpressionResult(e);this.isObservableArray(n)?n[t].apply(n,r):console.error("Cannot execute '"+t+"' function on ko.computed because the expression '"+e+"' does not return an observable array.")},DotvvmEvaluator.prototype.getExpressionResult=function(e){var t=e();return ko.isComputed(t)&&"wrappedProperty"in t&&(t=t.wrappedProperty()),t},DotvvmEvaluator}(),DotvvmEventHub=function(){function e(){this.map={}}return e.prototype.notify=function(e){e in this.map?this.map[e].notifySubscribers():this.map[e]=ko.observable(0)},e.prototype.get=function(e){return this.map[e]||(this.map[e]=ko.observable(0))},e}();function basicAuthenticatedFetch(t,r){var n=sessionStorage.getItem("someAuth");return null!=n&&(null==r&&(r={}),null==r.headers&&(r.headers={}),null==r.headers.Authorization&&(r.headers.Authorization="Basic "+btoa(n))),null==r&&(r={}),r.cache||(r.cache="no-cache"),window.fetch(t,r).then(function(e){return 401===e.status&&null==n?(null==sessionStorage.getItem("someAuth")&&function(){var e=prompt("You credentials for "+(t.url||t))||"";sessionStorage.setItem("someAuth",e)}(),basicAuthenticatedFetch(t,r)):e})}!function(){var p={};DotVVM.prototype.invokeApiFn=function(e,t,r,n,o,i,a){var s=ko.ignoreDependencies(r),l=function(){return e[t].apply(e,s)},u=t+":"+a(s),d=i?i.apiCachedValues||(i.apiCachedValues={}):p,v=d[u]||(d[u]=ko.observable(null)),c=ko.pureComputed(function(){return v()});return c.refreshValue=function(e){var t=v.promise;if(v.isLoading||(v.isLoading=!0,t=function(){try{return{type:"result",result:window.Promise.resolve(ko.ignoreDependencies(l)).then(function(e){e&&(v(ko.unwrap(dotvvm.serialization.deserialize(e))),v.notifySubscribers());for(var t=0,r=o(s);t<r.length;t++){var n=r[t];dotvvm.eventHub.notify(n)}return e},console.warn)}}catch(e){return console.warn(e),{type:"error",error:e}}}(),v.promise=t),"error"!=t.type)return t.result.then(function(e){return v.isLoading=!1},function(e){return v.isLoading=!1}),t.result;if(v.isLoading=!1,e)throw t.error},v.peek()||c.refreshValue(),ko.computed(function(){return n(s).map(function(e){return"string"==typeof e?dotvvm.eventHub.get(e)():e()})}).subscribe(function(e){return c.refreshValue()}),c},DotVVM.prototype.apiRefreshOn=function(e,t){return"function"!=typeof e.refreshValue&&console.error("The object is not refreshable"),t.subscribe(function(){"function"!=typeof e.refreshValue&&console.error("The object is not refreshable"),e.refreshValue&&e.refreshValue()}),e},DotVVM.prototype.api={},DotVVM.prototype.eventHub=new DotvvmEventHub}();
>>>>>>> 76abeb8520ef79f07ea4f0fdfc9368695fd2efdf
