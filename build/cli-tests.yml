trigger:
- main

pool:
  name: 'DockerAgents'

variables:
  compilerPathFx: ./dotvvm/src/DotVVM.Compiler/bin/Debug/net461/DotVVM.Compiler.exe
  compilerPathCore: ./dotvvm/src/DotVVM.Compiler/bin/Debug/netcoreapp3.1/DotVVM.Compiler.exe

steps:
- checkout: self
  path: s/dotvvm
- checkout: git://DotVVM/cli-tests
  path: s/tests

## Compile DotVVM
- task: Npm@1
  displayName: "npm install"
  inputs:
    command: 'install'
    workingDir: 'dotvvm/src/DotVVM.Framework'

- task: Npm@1
  displayName: "npm run build"
  inputs:
    command: 'custom'
    workingDir: 'dotvvm/src/DotVVM.Framework'
    customCommand: 'run build'

- task: NuGetCommand@2
  displayName: "Restore packages in DotVVM"
  inputs:
    command: 'restore'
    restoreSolution: 'dotvvm/**/*.sln'
    feedsToUse: 'select'

- task: VSBuild@1
  displayName: "Build DotVVM"
  inputs:
    solution: 'dotvvm/**/*.sln'
    platform: 'Any CPU'
    configuration: 'Debug'

## Prepare test projects
- task: NuGetCommand@2
  displayName: "Restore packages in test projects"
  inputs:
    command: 'restore'
    restoreSolution: 'tests/**/*.sln'
    feedsToUse: 'config'
    nugetConfigPath: 'tests/NuGet.config'

- task: VSBuild@1
  displayName: "Compile test projects"
  inputs:
    solution: 'tests/**/*.sln'
    platform: 'Any CPU'
    configuration: 'Debug'

## Run tests
- task: PowerShell@2
  displayName: "Empty App (.NET Framework 4.5.1)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/empty_net451/EmptyNet451/bin/EmptyNet451.dll" "tests/owin/empty_net451/EmptyNet451"'
    failOnStderr: true
  continueOnError: true

- task: PowerShell@2
  displayName: "Empty App (.NET Framework 4.6.1)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/empty_net461/EmptyNet461/bin/EmptyNet461.dll" "tests/owin/empty_net461/EmptyNet461"'
    failOnStderr: true
  continueOnError: true

- task: PowerShell@2
  displayName: "Empty App (.NET Framework 4.7.2)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/empty_net472/EmptyNet472/bin/EmptyNet472.dll" "tests/owin/empty_net472/EmptyNet472"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Empty App (.NET Framework 4.8)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/empty_net48/EmptyNet48/bin/EmptyNet48.dll" "tests/owin/empty_net48/EmptyNet48"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Business Pack (.NET Framework 4.7.2)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/bp_net472/BusinessPack_Net472/bin/BusinessPack_Net472.dll" "tests/owin/bp_net472/BusinessPack_Net472"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Bootstrap 3 (.NET Framework 4.7.2)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/bs3_net472/Bootstrap3Net472/bin/Bootstrap3Net472.dll" "tests/owin/bp_net472/Bootstrap3Net472"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Bootstrap 4 (.NET Framework 4.7.2)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/bs4_net472/Bootstrap4Net472/bin/Bootstrap4Net472.dll" "tests/owin/bs4_net472/Bootstrap4Net472"'
    failOnStderr: true
  continueOnError: true
        
- task: PowerShell@2
  displayName: "Dynamic Data + Contrib (.NET Framework 4.7.2)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathFx)" "tests/owin/dyndata_net472/DynamicDataNet472/bin/DynamicDataNet472.dll" "tests/owin/dyndata_net472/DynamicDataNet472"'
    failOnStderr: true
  continueOnError: true

- task: PowerShell@2
  displayName: "Empty App (.NET Core 2.1)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/empty_core21/EmptyCore21/bin/Debug/netcoreapp2.1/EmptyCore21.dll" "tests/core/empty_core21/EmptyCore21"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Empty App (.NET Core 3.1)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/empty_core31/EmptyCore31/bin/Debug/netcoreapp3.1/EmptyCore31.dll" "tests/core/empty_core31/EmptyCore31"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Empty App (.NET 5.0)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/empty_net5/EmptyNet5/bin/Debug/net5.0/EmptyNet5.dll" "tests/core/empty_net5/EmptyNet5"'
    failOnStderr: true
  continueOnError: true
        
- task: PowerShell@2
  displayName: "Business Pack (.NET 5.0)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/bp_net5/BusinessPack_Net5/bin/Debug/net5.0/BusinessPack_Net5.dll" "tests/core/bp_net5/BusinessPack_Net5"'
    failOnStderr: true
  continueOnError: true

- task: PowerShell@2
  displayName: "Bootstrap 3 (.NET 5.0)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/bs3_net5/Bootstrap3_Net5/bin/Debug/net5.0/Bootstrap3_Net5.dll" "tests/core/bs3_net5/Bootstrap3_Net5"'
    failOnStderr: true
  continueOnError: true
    
- task: PowerShell@2
  displayName: "Bootstrap 4 (.NET 5.0)"
  inputs:
    targetType: 'inline'
    script: '& "$(compilerPathCore)" "tests/core/bs4_net5/Bootstrap4_Net5/bin/Debug/net5.0/Bootstrap4_Net5.dll" "tests/core/bs4_net5/Bootstrap4_Net5"'
    failOnStderr: true
  continueOnError: true